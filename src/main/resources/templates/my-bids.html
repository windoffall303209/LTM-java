<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Bids - Auction System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .bid-card {
        transition: transform 0.2s;
      }
      .bid-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }
      .leading-badge {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="/dashboard">üî® Auction System</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="/dashboard">Dashboard</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/my-bids">L∆∞·ª£t ƒê·∫∑t Gi√°</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/watchlist">Theo D√µi</a>
            </li>
          </ul>
          <ul class="navbar-nav">
            <li class="nav-item">
              <span class="nav-link" id="userBalance">
                üí∞ <strong>0 VND</strong>
              </span>
            </li>
            <li class="nav-item">
              <span class="nav-link" id="userInfo">
                üë§ <strong>User</strong>
              </span>
            </li>
            <li class="nav-item">
              <form
                method="POST"
                th:action="@{/api/auth/logout}"
                style="display: inline"
              >
                <button type="submit" class="btn btn-outline-light btn-sm">
                  ƒêƒÉng xu·∫•t
                </button>
              </form>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container py-4">
      <div class="row mb-4">
        <div class="col">
          <h2>üìä L·ªãch S·ª≠ ƒê·∫∑t Gi√° C·ªßa T√¥i</h2>
          <p class="text-muted">Xem t·∫•t c·∫£ c√°c l∆∞·ª£t ƒë·∫∑t gi√° c·ªßa b·∫°n</p>
        </div>
      </div>

      <!-- Statistics -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h3 class="text-primary mb-0" id="totalBidsCount">0</h3>
              <small class="text-muted">T·ªïng l∆∞·ª£t ƒë·∫∑t gi√°</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h3 class="text-success mb-0" id="leadingCount">0</h3>
              <small class="text-muted">ƒêang d·∫´n ƒë·∫ßu</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h3 class="text-warning mb-0" id="activeAuctionsCount">0</h3>
              <small class="text-muted">ƒê·∫•u gi√° ƒëang tham gia</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h3 class="text-info mb-0" id="totalSpent">0 VND</h3>
              <small class="text-muted">T·ªïng gi√° tr·ªã ƒë·∫∑t</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Filter -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <select class="form-select" id="filterStatus">
                <option value="all">T·∫•t c·∫£ ƒë·∫•u gi√°</option>
                <option value="active">ƒêang di·ªÖn ra</option>
                <option value="leading">ƒêang d·∫´n ƒë·∫ßu</option>
                <option value="ended">ƒê√£ k·∫øt th√∫c</option>
              </select>
            </div>
            <div class="col-md-6">
              <button class="btn btn-primary" onclick="loadMyBids()">
                üîÑ L√†m m·ªõi
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Bids List -->
      <div id="bidsList" class="row g-4">
        <!-- Bids will be loaded here -->
      </div>

      <div id="noBids" class="text-center py-5" style="display: none">
        <h4 class="text-muted">B·∫°n ch∆∞a ƒë·∫∑t gi√° n√†o</h4>
        <a href="/dashboard" class="btn btn-primary mt-3">
          Kh√°m ph√° ƒë·∫•u gi√°
        </a>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const userId = localStorage.getItem("userId") || 1;

      // Load user info
      function loadUserInfo() {
        const username = localStorage.getItem("username") || "User";
        const balance = localStorage.getItem("balance") || "0";
        document.getElementById("userInfo").innerHTML = `üë§ <strong>${username}</strong>`;
        document.getElementById("userBalance").innerHTML = `üí∞ <strong>${formatCurrency(balance)}</strong>`;
      }

      // Load my bids
      async function loadMyBids() {
        try {
          const response = await fetch(`/api/bids/user?userId=${userId}`);
          const result = await response.json();

          if (result.success && result.data) {
            displayBids(result.data);
            updateStatistics(result.data);
          }
        } catch (error) {
          console.error("Error loading bids:", error);
        }
      }

      function displayBids(bids) {
        const container = document.getElementById("bidsList");
        const noBids = document.getElementById("noBids");

        if (!bids || bids.length === 0) {
          container.style.display = "none";
          noBids.style.display = "block";
          return;
        }

        container.style.display = "flex";
        noBids.style.display = "none";
        container.innerHTML = "";

        // Group bids by auction
        const groupedBids = {};
        bids.forEach((bid) => {
          if (!groupedBids[bid.auctionId]) {
            groupedBids[bid.auctionId] = [];
          }
          groupedBids[bid.auctionId].push(bid);
        });

        // Display each auction
        Object.keys(groupedBids).forEach((auctionId) => {
          const auctionBids = groupedBids[auctionId];
          const latestBid = auctionBids[0];
          const myHighestBid = Math.max(...auctionBids.map((b) => b.bidAmount));
          const isLeading = latestBid.isHighest;

          const card = `
            <div class="col-md-6">
              <div class="card bid-card h-100 ${
                isLeading ? "border-success border-2" : ""
              }">
                ${
                  isLeading
                    ? '<div class="position-absolute top-0 end-0 m-2"><span class="badge bg-success leading-badge">üèÜ ƒêang d·∫´n ƒë·∫ßu</span></div>'
                    : ""
                }
                <div class="card-body">
                  <h5 class="card-title">${latestBid.auctionTitle || "Auction #" + auctionId}</h5>
                  
                  <div class="mb-2">
                    <small class="text-muted">Gi√° cao nh·∫•t c·ªßa b·∫°n:</small>
                    <div class="fs-4 text-primary fw-bold">${formatCurrency(
                      myHighestBid
                    )}</div>
                  </div>

                  <div class="mb-2">
                    <small class="text-muted">Gi√° hi·ªán t·∫°i:</small>
                    <div class="fs-5 ${
                      isLeading ? "text-success" : "text-danger"
                    }">${formatCurrency(latestBid.currentPrice || myHighestBid)}</div>
                  </div>

                  <div class="mb-3">
                    <small class="text-muted">S·ªë l·∫ßn ƒë·∫∑t gi√°:</small>
                    <span class="badge bg-primary">${
                      auctionBids.length
                    } l·∫ßn</span>
                    ${
                      auctionBids.some((b) => b.isAutoBid)
                        ? '<span class="badge bg-info ms-2">Auto Bid</span>'
                        : ""
                    }
                  </div>

                  <div class="mb-3">
                    <small class="text-muted">L·∫ßn ƒë·∫∑t cu·ªëi:</small>
                    <div>${formatDate(latestBid.bidTime)}</div>
                  </div>

                  <div class="d-grid gap-2">
                    <a href="/auction/${auctionId}" class="btn btn-primary">
                      Xem chi ti·∫øt
                    </a>
                  </div>
                </div>
              </div>
            </div>
          `;
          container.innerHTML += card;
        });
      }

      function updateStatistics(bids) {
        const totalBids = bids.length;
        const uniqueAuctions = new Set(bids.map((b) => b.auctionId)).size;
        const leadingCount = new Set(
          bids.filter((b) => b.isHighest).map((b) => b.auctionId)
        ).size;
        const totalSpent = bids.reduce(
          (sum, bid) => sum + bid.bidAmount,
          0
        );

        document.getElementById("totalBidsCount").textContent = totalBids;
        document.getElementById("leadingCount").textContent = leadingCount;
        document.getElementById("activeAuctionsCount").textContent =
          uniqueAuctions;
        document.getElementById("totalSpent").textContent =
          formatCurrency(totalSpent);
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat("vi-VN").format(amount) + " VND";
      }

      function formatDate(dateString) {
        return new Date(dateString).toLocaleString("vi-VN");
      }

      // Filter bids
      document
        .getElementById("filterStatus")
        .addEventListener("change", function () {
          loadMyBids();
        });

      // Initialize
      window.addEventListener("load", function () {
        loadUserInfo();
        loadMyBids();
      });
    </script>
  </body>
</html>

