<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Watchlist - Auction System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
    <style>
      .auction-card {
        transition: transform 0.2s;
      }
      .auction-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/dashboard">üî® Auction System</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link text-white fw-semibold" href="/dashboard">Dashboard</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white fw-semibold" href="/my-bids">L∆∞·ª£t ƒê·∫∑t Gi√°</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active fw-semibold" href="/watchlist">Theo D√µi</a>
            </li>
            <!-- Admin Menu -->
            <li class="nav-item" th:if="${isAdmin}">
              <a class="nav-link text-warning fw-bold" href="/admin">
                üëë Qu·∫£n Tr·ªã
              </a>
            </li>
          </ul>
          <ul class="navbar-nav">
            <!-- User Balance -->
            <li class="nav-item d-none d-lg-block">
              <span class="nav-link">
                üí∞ <strong th:text="${#numbers.formatDecimal(currentUser.balance, 0, 'COMMA', 0, 'POINT')} + ' VND'">10,000,000 VND</strong>
              </span>
            </li>
            <!-- Username with Dropdown -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle fw-semibold" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                üë§ <strong th:text="${currentUser.username}">User</strong>
                <span th:if="${isAdmin}" class="badge bg-warning text-dark ms-1">ADMIN</span>
                <span th:unless="${isAdmin}" class="badge bg-info ms-1">USER</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li class="dropdown-header">
                  <strong>Th√¥ng tin t√†i kho·∫£n</strong>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <span class="dropdown-item-text">
                    <small class="text-muted">T√™n ƒë·∫ßy ƒë·ªß:</small><br/>
                    <strong th:text="${currentUser.fullName}">Full Name</strong>
                  </span>
                </li>
                <li>
                  <span class="dropdown-item-text">
                    <small class="text-muted">Email:</small><br/>
                    <strong th:text="${currentUser.email}">email@example.com</strong>
                  </span>
                </li>
                <li>
                  <span class="dropdown-item-text">
                    <small class="text-muted">S·ªë d∆∞:</small><br/>
                    <strong class="text-success" th:text="${#numbers.formatDecimal(currentUser.balance, 0, 'COMMA', 0, 'POINT')} + ' VND'">0 VND</strong>
                  </span>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <form method="POST" th:action="@{/api/auth/logout}" class="px-2">
                    <button type="submit" class="btn btn-danger btn-sm w-100">
                      <i class="bi bi-box-arrow-right"></i> ƒêƒÉng xu·∫•t
                    </button>
                  </form>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container py-4">
      <div class="row mb-4">
        <div class="col">
          <h2>‚≠ê Danh S√°ch Theo D√µi</h2>
          <p class="text-muted">
            C√°c ƒë·∫•u gi√° b·∫°n ƒëang quan t√¢m (T·ªïng:
            <strong id="watchlistCount">0</strong>)
          </p>
        </div>
        <div class="col-auto">
          <button class="btn btn-primary" onclick="loadWatchlist()">
            üîÑ L√†m m·ªõi
          </button>
        </div>
      </div>

      <!-- Watchlist -->
      <div id="watchlistContainer" class="row g-4">
        <!-- Watchlist items will be loaded here -->
      </div>

      <div id="noWatchlist" class="text-center py-5" style="display: none">
        <h4 class="text-muted">Danh s√°ch theo d√µi tr·ªëng</h4>
        <p class="text-muted">
          Th√™m ƒë·∫•u gi√° v√†o watchlist ƒë·ªÉ theo d√µi d·ªÖ d√†ng h∆°n
        </p>
        <a href="/dashboard" class="btn btn-primary mt-3">
          Kh√°m ph√° ƒë·∫•u gi√°
        </a>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const userId = localStorage.getItem("userId") || 1;

      // Load user info
      function loadUserInfo() {
        const username = localStorage.getItem("username") || "User";
        const balance = localStorage.getItem("balance") || "0";
        document.getElementById("userInfo").innerHTML = `üë§ <strong>${username}</strong>`;
        document.getElementById("userBalance").innerHTML = `üí∞ <strong>${formatCurrency(balance)}</strong>`;
      }

      // Load watchlist
      async function loadWatchlist() {
        try {
          const response = await fetch(`/api/watchlist/user?userId=${userId}`);
          const result = await response.json();

          if (result.success && result.data) {
            displayWatchlist(result.data);
          }
        } catch (error) {
          console.error("Error loading watchlist:", error);
        }
      }

      function displayWatchlist(watchlist) {
        const container = document.getElementById("watchlistContainer");
        const noWatchlist = document.getElementById("noWatchlist");

        document.getElementById("watchlistCount").textContent =
          watchlist.length;

        if (!watchlist || watchlist.length === 0) {
          container.style.display = "none";
          noWatchlist.style.display = "block";
          return;
        }

        container.style.display = "flex";
        noWatchlist.style.display = "none";
        container.innerHTML = "";

        watchlist.forEach((item) => {
          const auction = item.auction;
          const card = `
            <div class="col-md-4">
              <div class="card auction-card h-100">
                <img 
                  src="${auction.imageUrl || "https://via.placeholder.com/400x300"}" 
                  class="card-img-top" 
                  alt="${auction.title}"
                  style="height: 180px; object-fit: cover;">
                <div class="card-body">
                  <h5 class="card-title">${auction.title}</h5>
                  
                  <div class="mb-2">
                    <small class="text-muted">Gi√° hi·ªán t·∫°i:</small>
                    <div class="fs-5 text-success fw-bold">
                      ${formatCurrency(auction.currentPrice)}
                    </div>
                  </div>

                  <div class="mb-2">
                    <small class="text-muted">Ng∆∞·ªùi d·∫´n ƒë·∫ßu:</small>
                    <div>${auction.highestBidder || "Ch∆∞a c√≥"}</div>
                  </div>

                  <div class="mb-2">
                    <small class="text-muted">Tr·∫°ng th√°i:</small>
                    <span class="badge ${
                      auction.status === "ACTIVE" ? "bg-success" : "bg-secondary"
                    }">
                      ${auction.status === "ACTIVE" ? "ƒêang di·ªÖn ra" : "ƒê√£ k·∫øt th√∫c"}
                    </span>
                  </div>

                  <div class="mb-3">
                    <small class="text-muted">ƒê√£ theo d√µi t·ª´:</small>
                    <div class="small">${formatDate(item.addedAt)}</div>
                  </div>

                  <div class="d-grid gap-2">
                    <a href="/auction/${auction.auctionId}" class="btn btn-primary">
                      Xem chi ti·∫øt
                    </a>
                    <button 
                      class="btn btn-outline-danger btn-sm" 
                      onclick="removeFromWatchlist(${item.watchlistId})">
                      üóëÔ∏è X√≥a kh·ªèi watchlist
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
          container.innerHTML += card;
        });
      }

      // Remove from watchlist
      async function removeFromWatchlist(watchlistId) {
        if (!confirm("X√≥a kh·ªèi watchlist?")) return;

        try {
          const response = await fetch(
            `/api/watchlist/${watchlistId}?userId=${userId}`,
            { method: "DELETE" }
          );

          const result = await response.json();

          if (result.success) {
            showNotification("ƒê√£ x√≥a kh·ªèi watchlist", "success");
            loadWatchlist();
          } else {
            showNotification(result.message, "danger");
          }
        } catch (error) {
          showNotification("C√≥ l·ªói x·∫£y ra!", "danger");
        }
      }

      function showNotification(message, type) {
        const notification = document.createElement("div");
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        notification.style.zIndex = "9999";
        notification.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 3000);
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat("vi-VN").format(amount) + " VND";
      }

      function formatDate(dateString) {
        return new Date(dateString).toLocaleString("vi-VN");
      }

      // Initialize
      window.addEventListener("load", function () {
        loadUserInfo();
        loadWatchlist();
      });
    </script>
  </body>
</html>

