<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω Auctions - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold fs-5" href="/admin">üëë Admin Panel</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link text-white fw-semibold" href="/admin"><i class="bi bi-speedometer2"></i> Dashboard</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active fw-semibold" href="/admin/auctions"><i class="bi bi-hammer"></i> Qu·∫£n l√Ω ƒê·∫•u Gi√°</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white fw-semibold" href="/admin/users"><i class="bi bi-people"></i> Qu·∫£n l√Ω Ng∆∞·ªùi D√πng</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white fw-semibold" href="/dashboard"><i class="bi bi-arrow-left"></i> V·ªÅ Dashboard</a>
            </li>
          </ul>
          <ul class="navbar-nav">
            <li class="nav-item">
              <span class="nav-link">
                \ud83d\udc64 <strong th:text="${currentUser.username}">Admin</strong>
                <span class="badge bg-warning text-dark ms-1">ADMIN</span>
              </span>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid py-4">
      <div class="d-flex justify-content-between mb-4">
        <h2><i class="bi bi-hammer"></i> Qu·∫£n L√Ω ƒê·∫•u Gi√°</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createAuctionModal">
          <i class="bi bi-plus-circle"></i> T·∫°o ƒê·∫•u Gi√° M·ªõi
        </button>
      </div>

      <!-- Auctions List -->
      <div class="card">
        <div class="card-body">
          <table class="table table-hover" id="auctionsTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Ti√™u ƒë·ªÅ</th>
                <th>Gi√° hi·ªán t·∫°i</th>
                <th>Tr·∫°ng th√°i</th>
                <th>T·ªïng l∆∞·ª£t ƒë·∫∑t</th>
                <th>Th·ªùi gian</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody id="auctionsList">
              <tr><td colspan="7" class="text-center">ƒêang t·∫£i...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Create Auction Modal -->
    <div class="modal fade" id="createAuctionModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">T·∫°o ƒê·∫•u Gi√° M·ªõi</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form id="createAuctionForm">
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Ti√™u ƒë·ªÅ *</label>
                <input type="text" class="form-control" id="title" required />
              </div>
              <div class="mb-3">
                <label class="form-label">M√¥ t·∫£</label>
                <textarea class="form-control" id="description" rows="3"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Gi√° kh·ªüi ƒëi·ªÉm (VND) *</label>
                <input type="number" class="form-control" id="startingPrice" required step="100000" />
              </div>
              <div class="mb-3">
                <label class="form-label">Th·ªùi gian (ph√∫t) *</label>
                <input type="number" class="form-control" id="durationMinutes" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Link h√¨nh ·∫£nh</label>
                <input type="text" class="form-control" id="imageUrl" placeholder="https://..." />
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
              <button type="submit" class="btn btn-primary">T·∫°o ƒê·∫•u Gi√°</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      async function loadAuctions() {
        const response = await fetch("/api/admin/auctions/all");
        const result = await response.json();
        if (result.success) {
          displayAuctions(result.data);
        }
      }

      function displayAuctions(auctions) {
        const tbody = document.getElementById("auctionsList");
        tbody.innerHTML = "";
        auctions.forEach((a) => {
          const statusBadge = a.status === "ACTIVE" ? "bg-success" : a.status === "ENDED" ? "bg-secondary" : "bg-warning";
          tbody.innerHTML += `
            <tr>
              <td>${a.auctionId}</td>
              <td><strong>${a.title}</strong></td>
              <td>${formatCurrency(a.currentPrice)}</td>
              <td><span class="badge ${statusBadge}">${a.status}</span></td>
              <td>${a.totalBids}</td>
              <td><small>${new Date(a.startTime).toLocaleString("vi-VN")}</small></td>
              <td>
                ${a.status === "PENDING" ? `<button class="btn btn-sm btn-success" onclick="startAuction(${a.auctionId})">Start</button>` : ""}
                ${a.status === "ACTIVE" ? `<button class="btn btn-sm btn-danger" onclick="endAuction(${a.auctionId})">End</button>` : ""}
                <button class="btn btn-sm btn-danger" onclick="deleteAuction(${a.auctionId})"><i class="bi bi-trash"></i></button>
              </td>
            </tr>
          `;
        });
      }

      document.getElementById("createAuctionForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = new URLSearchParams({
          title: document.getElementById("title").value,
          description: document.getElementById("description").value,
          startingPrice: document.getElementById("startingPrice").value,
          durationMinutes: document.getElementById("durationMinutes").value,
          imageUrl: document.getElementById("imageUrl").value,
        });
        const response = await fetch("/api/admin/auctions?" + data, { method: "POST" });
        const result = await response.json();
        if (result.success) {
          alert("T·∫°o ƒë·∫•u gi√° th√†nh c√¥ng!");
          location.reload();
        } else {
          alert("L·ªói: " + result.message);
        }
      });

      async function startAuction(id) {
        if (!confirm("B·∫Øt ƒë·∫ßu ƒë·∫•u gi√° n√†y?")) return;
        const response = await fetch(`/api/admin/auctions/${id}/start`, { method: "POST" });
        const result = await response.json();
        if (result.success) {
          alert("ƒê√£ b·∫Øt ƒë·∫ßu!");
          loadAuctions();
        }
      }

      async function endAuction(id) {
        if (!confirm("K·∫øt th√∫c ƒë·∫•u gi√° n√†y?")) return;
        const response = await fetch(`/api/admin/auctions/${id}/end`, { method: "POST" });
        const result = await response.json();
        if (result.success) {
          alert("ƒê√£ k·∫øt th√∫c!");
          loadAuctions();
        }
      }

      async function deleteAuction(id) {
        if (!confirm("X√≥a ƒë·∫•u gi√° n√†y?")) return;
        const response = await fetch(`/api/admin/auctions/${id}`, { method: "DELETE" });
        const result = await response.json();
        if (result.success) {
          alert("ƒê√£ x√≥a!");
          loadAuctions();
        } else {
          alert("L·ªói: " + result.message);
        }
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat("vi-VN").format(amount) + " VND";
      }

      window.addEventListener("load", loadAuctions);
    </script>
  </body>
</html>

