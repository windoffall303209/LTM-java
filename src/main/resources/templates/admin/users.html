<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω Users - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold fs-5" href="/admin">üëë Admin Panel</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link text-white fw-semibold" href="/admin"><i class="bi bi-speedometer2"></i> Dashboard</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white fw-semibold" href="/admin/auctions"><i class="bi bi-hammer"></i> Qu·∫£n l√Ω ƒê·∫•u Gi√°</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active fw-semibold" href="/admin/users"><i class="bi bi-people"></i> Qu·∫£n l√Ω Ng∆∞·ªùi D√πng</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white fw-semibold" href="/dashboard"><i class="bi bi-arrow-left"></i> V·ªÅ Dashboard</a>
            </li>
          </ul>
          <ul class="navbar-nav">
            <li class="nav-item">
              <span class="nav-link">
                üë§ <strong th:text="${currentUser.username}">Admin</strong>
                <span class="badge bg-warning text-dark ms-1">ADMIN</span>
              </span>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid py-4">
      <div class="d-flex justify-content-between mb-4">
        <h2><i class="bi bi-people"></i> Qu·∫£n L√Ω Ng∆∞·ªùi D√πng</h2>
        <button class="btn btn-primary" onclick="loadUsers()">
          <i class="bi bi-arrow-clockwise"></i> L√†m M·ªõi
        </button>
      </div>

      <!-- Users List -->
      <div class="card">
        <div class="card-body">
          <table class="table table-hover" id="usersTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>T√™n ƒëƒÉng nh·∫≠p</th>
                <th>Email</th>
                <th>H·ªç t√™n</th>
                <th>S·ªë d∆∞</th>
                <th>Vai tr√≤</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Ng√†y t·∫°o</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody id="usersList">
              <tr><td colspan="9" class="text-center">ƒêang t·∫£i...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Update Balance Modal -->
    <div class="modal fade" id="updateBalanceModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">C·∫≠p Nh·∫≠t S·ªë D∆∞</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form id="updateBalanceForm">
            <div class="modal-body">
              <input type="hidden" id="updateUserId" />
              <div class="mb-3">
                <label class="form-label">S·ªë ti·ªÅn thay ƒë·ªïi (VND)</label>
                <input type="number" class="form-control" id="balanceAmount" required step="100000" placeholder="Nh·∫≠p s·ªë ti·ªÅn (d∆∞∆°ng: c·ªông, √¢m: tr·ª´)" />
                <small class="text-muted">VD: 1000000 ƒë·ªÉ c·ªông 1 tri·ªáu, -500000 ƒë·ªÉ tr·ª´ 500k</small>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
              <button type="submit" class="btn btn-primary">C·∫≠p Nh·∫≠t</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let updateBalanceModalInstance;

      async function loadUsers() {
        const response = await fetch("/api/admin/users");
        const result = await response.json();
        if (result.success) {
          displayUsers(result.data);
        }
      }

      function displayUsers(users) {
        const tbody = document.getElementById("usersList");
        tbody.innerHTML = "";
        users.forEach((user) => {
          const statusBadge = user.isActive
            ? '<span class="badge bg-success">Active</span>'
            : '<span class="badge bg-danger">Banned</span>';
          const roleBadge = user.role === "ADMIN"
            ? '<span class="badge bg-warning text-dark">ADMIN</span>'
            : '<span class="badge bg-info">USER</span>';

          tbody.innerHTML += `
            <tr>
              <td>${user.userId}</td>
              <td><strong>${user.username}</strong></td>
              <td>${user.email}</td>
              <td>${user.fullName || "-"}</td>
              <td class="text-success"><strong>${formatCurrency(user.balance)}</strong></td>
              <td>${roleBadge}</td>
              <td>${statusBadge}</td>
              <td><small>${new Date(user.createdAt).toLocaleDateString("vi-VN")}</small></td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="openUpdateBalance(${user.userId})">
                  <i class="bi bi-cash"></i>
                </button>
                <button class="btn btn-sm ${user.isActive ? "btn-warning" : "btn-success"}" 
                        onclick="toggleUserStatus(${user.userId})">
                  ${user.isActive ? '<i class="bi bi-ban"></i>' : '<i class="bi bi-check-circle"></i>'}
                </button>
              </td>
            </tr>
          `;
        });
      }

      function openUpdateBalance(userId) {
        document.getElementById("updateUserId").value = userId;
        document.getElementById("balanceAmount").value = "";
        updateBalanceModalInstance = new bootstrap.Modal(document.getElementById("updateBalanceModal"));
        updateBalanceModalInstance.show();
      }

      document.getElementById("updateBalanceForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const userId = document.getElementById("updateUserId").value;
        const amount = document.getElementById("balanceAmount").value;

        const response = await fetch(`/api/admin/users/${userId}/update-balance?amount=${amount}`, {
          method: "POST",
        });

        const result = await response.json();

        if (result.success) {
          alert("C·∫≠p nh·∫≠t s·ªë d∆∞ th√†nh c√¥ng!");
          updateBalanceModalInstance.hide();
          loadUsers();
        } else {
          alert("L·ªói: " + result.message);
        }
      });

      async function toggleUserStatus(userId) {
        if (!confirm("Thay ƒë·ªïi tr·∫°ng th√°i ng∆∞·ªùi d√πng n√†y?")) return;

        const response = await fetch(`/api/admin/users/${userId}/toggle-status`, {
          method: "POST",
        });

        const result = await response.json();

        if (result.success) {
          alert("ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i!");
          loadUsers();
        } else {
          alert("L·ªói: " + result.message);
        }
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat("vi-VN").format(amount) + " VND";
      }

      window.addEventListener("load", loadUsers);
    </script>
  </body>
</html>

