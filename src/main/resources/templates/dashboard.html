<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Auction System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
    <style>
      .navbar {
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 1000;
        transition: all 0.3s ease;
      }
      
      .navbar.navbar-shrink {
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
      }
      
      .navbar.navbar-shrink .navbar-brand {
        font-size: 1rem;
      }
      
      body {
        padding-top: 70px;
      }

      /* Ribbon for pending auctions */
      .ribbon-wrapper {
        width: 85px;
        height: 88px;
        overflow: hidden;
        position: absolute;
        top: -3px;
        right: -3px;
        z-index: 10;
      }

      .ribbon {
        font-size: 11px;
        font-weight: bold;
        color: #333;
        text-align: center;
        transform: rotate(45deg);
        position: relative;
        padding: 7px 0;
        left: -5px;
        top: 15px;
        width: 120px;
        box-shadow: 0 4px 6px rgba(0,0,0,.1);
      }

      /* Card border for pending */
      .card.border-warning {
        border-width: 2px;
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary" id="mainNav">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/dashboard">üî® Auction System</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link active fw-semibold" href="/dashboard">Dashboard</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white fw-semibold" href="/my-bids">L·ªãch S·ª≠ ƒê·∫•u Gi√°</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white fw-semibold" href="/watchlist">Theo D√µi</a>
            </li>
            <!-- Admin Menu -->
            <li class="nav-item" th:if="${isAdmin}">
              <a class="nav-link text-warning fw-bold" href="/admin">
                üëë Qu·∫£n Tr·ªã
              </a>
            </li>
          </ul>
          <ul class="navbar-nav">
            <!-- User Balance -->
            <li class="nav-item d-none d-lg-block">
              <span class="nav-link text-white">
                <strong>üí∞ <span th:text="${#numbers.formatDecimal(currentUser.balance, 0, 'COMMA', 0, 'POINT')} + ' VND'">10,000,000 VND</span></strong>
              </span>
            </li>
            <!-- Username with Dropdown -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <strong>üë§ <span th:text="${currentUser.fullName != null && !currentUser.fullName.isEmpty() ? currentUser.fullName : currentUser.username}">User</span></strong>
                <span th:if="${isAdmin}" class="badge bg-warning text-dark ms-1">ADMIN</span>
                <span th:unless="${isAdmin}" class="badge bg-info ms-1">USER</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li class="dropdown-header">
                  <strong>Th√¥ng tin t√†i kho·∫£n</strong>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <span class="dropdown-item-text">
                    <small class="text-muted">T√™n ƒë·∫ßy ƒë·ªß:</small><br/>
                    <strong th:text="${currentUser.fullName}">Full Name</strong>
                  </span>
                </li>
                <li>
                  <span class="dropdown-item-text">
                    <small class="text-muted">Email:</small><br/>
                    <strong th:text="${currentUser.email}">email@example.com</strong>
                  </span>
                </li>
                <li>
                  <span class="dropdown-item-text">
                    <small class="text-muted">S·ªë d∆∞:</small><br/>
                    <strong class="text-success" th:text="${#numbers.formatDecimal(currentUser.balance, 0, 'COMMA', 0, 'POINT')} + ' VND'">0 VND</strong>
                  </span>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <form method="POST" th:action="@{/api/auth/logout}" class="px-2">
                    <button type="submit" class="btn btn-danger btn-sm w-100">
                      <i class="bi bi-box-arrow-right"></i> ƒêƒÉng xu·∫•t
                    </button>
                  </form>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid py-4">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">B·ªô l·ªçc</h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">T√¨m ki·∫øm</label>
                <input
                  type="text"
                  class="form-control"
                  id="searchInput"
                  placeholder="Nh·∫≠p t·ª´ kh√≥a..."
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Tr·∫°ng th√°i</label>
                <select class="form-select" id="statusFilter">
                  <option value="">T·∫•t c·∫£</option>
                  <option value="ACTIVE" selected>ƒêang di·ªÖn ra</option>
                  <option value="ENDED">ƒê√£ k·∫øt th√∫c</option>
                </select>
              </div>
              <button class="btn btn-primary w-100" onclick="applyFilters()">
                √Åp d·ª•ng
              </button>
            </div>
          </div>

          <!-- Statistics -->
          <div class="card mt-3">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">Th·ªëng k√™</h5>
            </div>
            <div class="card-body">
              <div class="d-flex justify-content-between mb-2">
                <span>ƒê·∫•u gi√° ƒëang di·ªÖn ra:</span>
                <strong id="activeCount">0</strong>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span>L∆∞·ª£t ƒë·∫∑t gi√° c·ªßa b·∫°n:</span>
                <strong id="myBidsCount">0</strong>
              </div>
              <div class="d-flex justify-content-between">
                <span>ƒêang d·∫´n ƒë·∫ßu:</span>
                <strong id="leadingCount">0</strong>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
          <h2 class="mb-4">üî® ƒê·∫•u Gi√° ƒêang Di·ªÖn Ra</h2>

          <div class="row g-4" id="auctionsList">
            <!-- Auctions will be loaded here -->
          </div>

          <div id="noAuctions" class="text-center py-5" style="display: none">
            <h4 class="text-muted">Kh√¥ng c√≥ ƒë·∫•u gi√° n√†o ƒëang di·ªÖn ra</h4>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script>
      async function loadAuctions() {
        try {
          const response = await fetch("/api/auctions");
          const result = await response.json();

          if (result.success) {
            displayAuctions(result.data);
            document.getElementById("activeCount").textContent =
              result.data.length;
          }
        } catch (error) {
          console.error("Error loading auctions:", error);
        }
      }

      function displayAuctions(auctions) {
        const container = document.getElementById("auctionsList");
        const noAuctions = document.getElementById("noAuctions");

        if (auctions.length === 0) {
          container.style.display = "none";
          noAuctions.style.display = "block";
          return;
        }

        container.style.display = "flex";
        noAuctions.style.display = "none";
        container.innerHTML = "";

        auctions.forEach((auction) => {
          const card = createAuctionCard(auction);
          container.innerHTML += card;
        });
      }

      function createAuctionCard(auction) {
        const imageUrl =
          auction.imageUrl || "https://via.placeholder.com/400x300";
        const priceFormatted = new Intl.NumberFormat("vi-VN").format(
          auction.currentPrice
        );
        const minBidFormatted = new Intl.NumberFormat("vi-VN").format(
          auction.minimumBid
        );

        // Ki·ªÉm tra tr·∫°ng th√°i
        const isPending = auction.status === "PENDING";
        const statusBadge = isPending 
          ? '<span class="badge bg-warning text-dark mb-2"><i class="bi bi-clock-history"></i> S·∫Øp di·ªÖn ra</span>'
          : '<span class="badge bg-success mb-2"><i class="bi bi-broadcast"></i> ƒêang di·ªÖn ra</span>';
        
        const cardBorder = isPending ? "border-warning" : "";
        const startTimeText = isPending 
          ? `<div class="mb-2"><strong>B·∫Øt ƒë·∫ßu l√∫c:</strong> <span class="text-primary">${new Date(auction.startTime).toLocaleString("vi-VN")}</span></div>`
          : "";
        
        const buttonText = isPending ? "Xem chi ti·∫øt & Theo d√µi" : "Xem chi ti·∫øt & ƒê·∫•u gi√°";
        const buttonClass = isPending ? "btn btn-outline-primary w-100" : "btn btn-primary w-100";

        return `
                <div class="col-md-4">
                    <div class="card h-100 shadow-sm ${cardBorder}">
                        ${isPending ? '<div class="ribbon-wrapper"><div class="ribbon bg-warning text-dark">S·∫Øp di·ªÖn ra</div></div>' : ''}
                        <img src="${imageUrl}" class="card-img-top" alt="${auction.title}" 
                             style="height: 180px; object-fit: cover; ${isPending ? 'opacity: 0.85;' : ''}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">${auction.title}</h5>
                                ${statusBadge}
                            </div>
                            <div class="mb-2">
                                <strong>${isPending ? 'Gi√° kh·ªüi ƒëi·ªÉm:' : 'Gi√° hi·ªán t·∫°i:'}</strong>
                                <div class="text-success fs-5">${priceFormatted} VND</div>
                            </div>
                            ${!isPending ? `
                            <div class="mb-2">
                                <small><strong>Gi√° t·ªëi thi·ªÉu:</strong> ${minBidFormatted} VND</small>
                            </div>
                            <div class="mb-2">
                                <strong>Ng∆∞·ªùi d·∫´n ƒë·∫ßu:</strong> ${auction.highestBidder}
                            </div>
                            <div class="mb-2">
                                <strong>Th·ªùi gian c√≤n l·∫°i:</strong>
                                <span class="badge bg-danger">${formatTime(auction.secondsRemaining)}</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">${auction.totalBids} l∆∞·ª£t ƒë·∫∑t gi√°</small>
                            </div>
                            ` : `
                            ${startTimeText}
                            <div class="mb-2">
                                <small class="text-muted"><i class="bi bi-calendar-event"></i> K·∫øt th√∫c: ${new Date(auction.endTime).toLocaleString("vi-VN")}</small>
                            </div>
                            <div class="alert alert-info py-2 mb-2">
                                <small><i class="bi bi-info-circle"></i> Ch∆∞a c√≥ ai ƒë·∫∑t gi√°. H√£y theo d√µi ƒë·ªÉ kh√¥ng b·ªè l·ª°!</small>
                            </div>
                            `}
                        </div>
                        <div class="card-footer bg-transparent">
                            <a href="/auction/${auction.auctionId}" class="${buttonClass}">
                                ${buttonText}
                            </a>
                        </div>
                    </div>
                </div>
            `;
      }

      function formatTime(seconds) {
        if (seconds <= 0) return "ƒê√£ k·∫øt th√∫c";
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${hours}h ${minutes}m ${secs}s`;
      }

      function applyFilters() {
        loadAuctions();
      }

      // Navbar shrink on scroll
      window.addEventListener('scroll', function() {
        const navbar = document.getElementById('mainNav');
        if (window.scrollY > 50) {
          navbar.classList.add('navbar-shrink');
        } else {
          navbar.classList.remove('navbar-shrink');
        }
      });

      // WebSocket connection for real-time notifications
      function connectWebSocket() {
        try {
          const socket = new SockJS("/ws");
          const stompClient = Stomp.over(socket);
          
          // Disable debug logging in production
          stompClient.debug = null;
          
          stompClient.connect({}, function (frame) {
            console.log("‚úÖ Dashboard connected to WebSocket");
            
            // Subscribe to general auction updates
            stompClient.subscribe("/topic/auctions", function (message) {
              try {
                const update = JSON.parse(message.body);
                console.log("üì© Received WebSocket message:", update.type);
                
                if (update.type === "AUCTION_CREATED") {
                  // Auction m·ªõi ƒë∆∞·ª£c t·∫°o
                  console.log("üÜï ƒê·∫•u gi√° m·ªõi: " + update.title + " ƒë√£ ƒë∆∞·ª£c t·∫°o!");
                  // Reload auctions
                  loadAuctions();
                } else if (update.type === "AUCTION_STARTED") {
                  // Show toast notification
                  console.log("üöÄ ƒê·∫•u gi√°: " + update.title + " ƒë√£ b·∫Øt ƒë·∫ßu!");
                  // Reload auctions
                  loadAuctions();
                } else if (update.type === "AUCTION_ENDED") {
                  // Show toast notification
                  const winnerMsg = update.winner ? " - Ng∆∞·ªùi th·∫Øng: " + update.winner : "";
                  console.log("üèÅ ƒê·∫•u gi√° " + update.title + " ƒë√£ k·∫øt th√∫c!" + winnerMsg);
                  // Reload auctions
                  loadAuctions();
                }
              } catch (error) {
                console.error("‚ùå Error parsing WebSocket message:", error);
              }
            });
          }, function (error) {
            console.error("‚ùå WebSocket connection error:", error);
          });
        } catch (error) {
          console.error("‚ùå Error creating WebSocket:", error);
        }
      }

      // Initialize
      window.addEventListener("load", function() {
        loadAuctions();
        connectWebSocket();
      });
    </script>
  </body>
</html>

