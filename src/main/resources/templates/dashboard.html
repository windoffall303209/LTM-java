<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Auction System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/dashboard">üî® Auction System</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link active fw-semibold" href="/dashboard">Dashboard</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white fw-semibold" href="/my-bids">L∆∞·ª£t ƒê·∫∑t Gi√°</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white fw-semibold" href="/watchlist">Theo D√µi</a>
            </li>
            <!-- Admin Menu -->
            <li class="nav-item" th:if="${isAdmin}">
              <a class="nav-link text-warning fw-bold" href="/admin">
                üëë Qu·∫£n Tr·ªã
              </a>
            </li>
          </ul>
          <ul class="navbar-nav">
            <!-- User Balance -->
            <li class="nav-item">
              <span class="nav-link">
                üí∞ <strong th:text="${#numbers.formatDecimal(currentUser.balance, 0, 'COMMA', 0, 'POINT')} + ' VND'">10,000,000 VND</strong>
              </span>
            </li>
            <!-- Username with Badge -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                üë§ <strong th:text="${currentUser.username}">User</strong>
                <span th:if="${isAdmin}" class="badge bg-warning text-dark ms-1">ADMIN</span>
                <span th:unless="${isAdmin}" class="badge bg-info ms-1">USER</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" href="#">
                    <small class="text-muted">T√™n ƒë·∫ßy ƒë·ªß:</small><br/>
                    <strong th:text="${currentUser.fullName}">Full Name</strong>
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="#">
                    <small class="text-muted">Email:</small><br/>
                    <strong th:text="${currentUser.email}">email@example.com</strong>
                  </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <a class="dropdown-item" href="#">
                    <small class="text-muted">Role:</small><br/>
                    <span th:if="${isAdmin}" class="badge bg-warning text-dark">ADMIN</span>
                    <span th:unless="${isAdmin}" class="badge bg-info">USER</span>
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="#">
                    <small class="text-muted">S·ªë d∆∞:</small><br/>
                    <strong class="text-success" th:text="${#numbers.formatDecimal(currentUser.balance, 0, 'COMMA', 0, 'POINT')} + ' VND'">0 VND</strong>
                  </a>
                </li>
              </ul>
            </li>
            <!-- Logout -->
            <li class="nav-item">
              <form
                method="POST"
                th:action="@{/api/auth/logout}"
                style="display: inline"
              >
                <button type="submit" class="btn btn-outline-light btn-sm ms-2">
                  ƒêƒÉng xu·∫•t
                </button>
              </form>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid py-4">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">B·ªô l·ªçc</h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">T√¨m ki·∫øm</label>
                <input
                  type="text"
                  class="form-control"
                  id="searchInput"
                  placeholder="Nh·∫≠p t·ª´ kh√≥a..."
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Tr·∫°ng th√°i</label>
                <select class="form-select" id="statusFilter">
                  <option value="">T·∫•t c·∫£</option>
                  <option value="ACTIVE" selected>ƒêang di·ªÖn ra</option>
                  <option value="ENDED">ƒê√£ k·∫øt th√∫c</option>
                </select>
              </div>
              <button class="btn btn-primary w-100" onclick="applyFilters()">
                √Åp d·ª•ng
              </button>
            </div>
          </div>

          <!-- Statistics -->
          <div class="card mt-3">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">Th·ªëng k√™</h5>
            </div>
            <div class="card-body">
              <div class="d-flex justify-content-between mb-2">
                <span>ƒê·∫•u gi√° ƒëang di·ªÖn ra:</span>
                <strong id="activeCount">0</strong>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span>L∆∞·ª£t ƒë·∫∑t gi√° c·ªßa b·∫°n:</span>
                <strong id="myBidsCount">0</strong>
              </div>
              <div class="d-flex justify-content-between">
                <span>ƒêang d·∫´n ƒë·∫ßu:</span>
                <strong id="leadingCount">0</strong>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
          <h2 class="mb-4">üî® ƒê·∫•u Gi√° ƒêang Di·ªÖn Ra</h2>

          <div class="row g-4" id="auctionsList">
            <!-- Auctions will be loaded here -->
          </div>

          <div id="noAuctions" class="text-center py-5" style="display: none">
            <h4 class="text-muted">Kh√¥ng c√≥ ƒë·∫•u gi√° n√†o ƒëang di·ªÖn ra</h4>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Load auctions on page load
      window.addEventListener("load", loadAuctions);

      async function loadAuctions() {
        try {
          const response = await fetch("/api/auctions");
          const result = await response.json();

          if (result.success) {
            displayAuctions(result.data);
            document.getElementById("activeCount").textContent =
              result.data.length;
          }
        } catch (error) {
          console.error("Error loading auctions:", error);
        }
      }

      function displayAuctions(auctions) {
        const container = document.getElementById("auctionsList");
        const noAuctions = document.getElementById("noAuctions");

        if (auctions.length === 0) {
          container.style.display = "none";
          noAuctions.style.display = "block";
          return;
        }

        container.style.display = "flex";
        noAuctions.style.display = "none";
        container.innerHTML = "";

        auctions.forEach((auction) => {
          const card = createAuctionCard(auction);
          container.innerHTML += card;
        });
      }

      function createAuctionCard(auction) {
        const imageUrl =
          auction.imageUrl || "https://via.placeholder.com/400x300";
        const priceFormatted = new Intl.NumberFormat("vi-VN").format(
          auction.currentPrice
        );
        const minBidFormatted = new Intl.NumberFormat("vi-VN").format(
          auction.minimumBid
        );

        return `
                <div class="col-md-4">
                    <div class="card h-100 shadow-sm">
                        <img src="${imageUrl}" class="card-img-top" alt="${
          auction.title
        }" 
                             style="height: 180px; object-fit: cover;">
                        <div class="card-body">
                            <h5 class="card-title">${auction.title}</h5>
                            <div class="mb-2">
                                <strong>Gi√° hi·ªán t·∫°i:</strong>
                                <div class="text-success fs-5">${priceFormatted} VND</div>
                            </div>
                            <div class="mb-2">
                                <small><strong>Gi√° t·ªëi thi·ªÉu:</strong> ${minBidFormatted} VND</small>
                            </div>
                            <div class="mb-2">
                                <strong>Ng∆∞·ªùi d·∫´n ƒë·∫ßu:</strong> ${
                                  auction.highestBidder
                                }
                            </div>
                            <div class="mb-2">
                                <strong>Th·ªùi gian:</strong>
                                <span class="badge bg-danger">${formatTime(
                                  auction.secondsRemaining
                                )}</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">${
                                  auction.totalBids
                                } l∆∞·ª£t ƒë·∫∑t gi√°</small>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            <a href="/auction/${
                              auction.auctionId
                            }" class="btn btn-primary w-100">
                                Xem chi ti·∫øt & ƒê·∫•u gi√°
                            </a>
                        </div>
                    </div>
                </div>
            `;
      }

      function formatTime(seconds) {
        if (seconds <= 0) return "ƒê√£ k·∫øt th√∫c";
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${hours}h ${minutes}m ${secs}s`;
      }

      function applyFilters() {
        loadAuctions();
      }
    </script>
  </body>
</html>
