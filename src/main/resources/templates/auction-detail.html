<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${auction.title} + ' - Auction System'">
      Auction Detail
    </title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/dashboard">üî® Auction System</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link text-white fw-semibold" href="/dashboard">‚Üê Quay l·∫°i Dashboard</a>
            </li>
          </ul>
          <ul class="navbar-nav">
            <!-- User Balance -->
            <li class="nav-item d-none d-lg-block">
              <span class="nav-link">
                üí∞ <strong th:text="${#numbers.formatDecimal(currentUser.balance, 0, 'COMMA', 0, 'POINT')} + ' VND'">10,000,000 VND</strong>
              </span>
            </li>
            <!-- Username with Dropdown -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle fw-semibold" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                üë§ <strong th:text="${currentUser.username}">User</strong>
                <span th:if="${isAdmin}" class="badge bg-warning text-dark ms-1">ADMIN</span>
                <span th:unless="${isAdmin}" class="badge bg-info ms-1">USER</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li class="dropdown-header">
                  <strong>Th√¥ng tin t√†i kho·∫£n</strong>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <span class="dropdown-item-text">
                    <small class="text-muted">T√™n ƒë·∫ßy ƒë·ªß:</small><br/>
                    <strong th:text="${currentUser.fullName}">Full Name</strong>
                  </span>
                </li>
                <li>
                  <span class="dropdown-item-text">
                    <small class="text-muted">Email:</small><br/>
                    <strong th:text="${currentUser.email}">email@example.com</strong>
                  </span>
                </li>
                <li>
                  <span class="dropdown-item-text">
                    <small class="text-muted">S·ªë d∆∞:</small><br/>
                    <strong class="text-success" th:text="${#numbers.formatDecimal(currentUser.balance, 0, 'COMMA', 0, 'POINT')} + ' VND'">0 VND</strong>
                  </span>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <form method="POST" th:action="@{/api/auth/logout}" class="px-2">
                    <button type="submit" class="btn btn-danger btn-sm w-100">
                      <i class="bi bi-box-arrow-right"></i> ƒêƒÉng xu·∫•t
                    </button>
                  </form>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container py-4">
      <div class="row">
        <!-- Main Auction Info -->
        <div class="col-md-8">
          <div class="card mb-4">
            <img
              th:src="${auction.imageUrl != null ? auction.imageUrl : 'https://via.placeholder.com/800x400'}"
              class="card-img-top"
              alt="Auction Image"
              style="max-height: 400px; object-fit: cover"
            />
            <div class="card-body">
              <h2 class="card-title" th:text="${auction.title}">
                Auction Title
              </h2>
              <p class="card-text" th:text="${auction.description}">
                Description...
              </p>

              <hr />

              <div class="row">
                <div class="col-md-6">
                  <h5>Gi√° kh·ªüi ƒëi·ªÉm:</h5>
                  <p
                    class="fs-5"
                    th:text="${#numbers.formatDecimal(auction.startingPrice, 0, 'COMMA', 0, 'POINT')} + ' VND'"
                  >
                    0 VND
                  </p>
                </div>
                <div class="col-md-6">
                  <h5>Gi√° hi·ªán t·∫°i:</h5>
                  <p
                    class="fs-3 text-success fw-bold"
                    id="currentPrice"
                    th:text="${#numbers.formatDecimal(auction.currentPrice, 0, 'COMMA', 0, 'POINT')} + ' VND'"
                  >
                    0 VND
                  </p>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <strong>Ng∆∞·ªùi d·∫´n ƒë·∫ßu:</strong>
                  <span
                    class="fs-5 text-primary"
                    id="highestBidder"
                    th:text="${auction.highestBidder}"
                    >Ch∆∞a c√≥</span
                  >
                </div>
                <div class="col-md-6">
                  <strong>T·ªïng l∆∞·ª£t ƒë·∫∑t:</strong>
                  <span
                    class="fs-5"
                    id="totalBids"
                    th:text="${auction.totalBids}"
                    >0</span
                  >
                </div>
              </div>

              <div class="alert alert-info">
                <strong>Th·ªùi gian c√≤n l·∫°i:</strong>
                <h3 class="mb-0 text-danger" id="timeRemaining">Loading...</h3>
              </div>

              <!-- Real-time Status -->
              <div id="statusMessage" class="alert" style="display: none"></div>
            </div>
          </div>

          <!-- Bid History -->
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">L·ªãch S·ª≠ ƒê·∫∑t Gi√°</h5>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto">
              <div id="bidHistoryList">
                <!-- Bid history will be loaded here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Bidding Panel -->
        <div class="col-md-4">
          <div class="card sticky-top" style="top: 20px">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">ƒê·∫∑t Gi√° Ngay</h5>
            </div>
            <div class="card-body">
              <form id="bidForm">
                <div class="mb-3">
                  <label class="form-label">Gi√° t·ªëi thi·ªÉu:</label>
                  <p
                    class="fs-5 fw-bold text-danger"
                    id="minimumBid"
                    th:text="${#numbers.formatDecimal(auction.minimumBid, 0, 'COMMA', 0, 'POINT')} + ' VND'"
                  >
                    0 VND
                  </p>
                </div>

                <div class="mb-3">
                  <label for="bidAmount" class="form-label"
                    >S·ªë ti·ªÅn ƒë·∫∑t gi√°:</label
                  >
                  <input
                    type="number"
                    class="form-control form-control-lg"
                    id="bidAmount"
                    required
                    th:value="${auction.minimumBid}"
                    step="100000"
                  />
                  <small class="text-muted">B·ªôi s·ªë c·ªßa 100,000 VND</small>
                </div>

                <button type="submit" class="btn btn-success btn-lg w-100 mb-2">
                  üî® ƒê·∫∑t Gi√° Ngay
                </button>

                <div class="d-grid gap-2">
                  <button
                    type="button"
                    class="btn btn-outline-primary"
                    onclick="quickBid()"
                  >
                    Quick Bid (Min Price)
                  </button>
                </div>
              </form>

              <hr />

              <!-- Auto Bid Section -->
              <div class="mb-3">
                <button
                  class="btn btn-info w-100"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#autoBidSection"
                >
                  ü§ñ ƒê·∫∑t Gi√° T·ª± ƒê·ªông
                </button>
                <div class="collapse mt-2" id="autoBidSection">
                  <div class="card card-body">
                    <form id="autoBidForm">
                      <div class="mb-2">
                        <label class="form-label small">Gi√° t·ªëi ƒëa:</label>
                        <input
                          type="number"
                          class="form-control"
                          id="autoBidMaxAmount"
                          required
                          step="100000"
                          placeholder="VD: 5000000"
                        />
                      </div>
                      <div class="mb-2">
                        <label class="form-label small">B∆∞·ªõc gi√° tƒÉng:</label>
                        <input
                          type="number"
                          class="form-control"
                          id="autoBidIncrement"
                          required
                          step="100000"
                          value="100000"
                        />
                      </div>
                      <button type="submit" class="btn btn-info w-100 btn-sm">
                        K√≠ch ho·∫°t
                      </button>
                    </form>
                    <div id="autoBidStatus" class="mt-2" style="display: none">
                      <div class="alert alert-success small mb-0">
                        ‚úÖ ƒê·∫∑t gi√° t·ª± ƒë·ªông ƒëang ho·∫°t ƒë·ªông<br />
                        T·ªëi ƒëa: <strong id="autoBidMaxDisplay">0</strong><br />
                        B∆∞·ªõc tƒÉng: <strong id="autoBidIncrementDisplay">0</strong>
                        <button
                          class="btn btn-danger btn-sm w-100 mt-2"
                          onclick="cancelAutoBid()"
                        >
                          H·ªßy
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <hr />

              <!-- Watchlist Button -->
              <div class="text-center">
                <button
                  class="btn btn-outline-secondary btn-sm w-100"
                  id="watchlistBtn"
                  onclick="toggleWatchlist()"
                >
                  ‚≠ê Th√™m v√†o Danh S√°ch Theo D√µi
                </button>
              </div>
            </div>
          </div>

          <!-- Tips -->
          <div class="card mt-3">
            <div class="card-body small">
              <h6>üí° L∆∞u √Ω:</h6>
              <ul class="mb-0">
                <li>Gi√° c·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c (real-time)</li>
                <li>ƒê·∫∑t gi√° trong 60 gi√¢y cu·ªëi s·∫Ω ƒë∆∞·ª£c gia h·∫°n th√™m th·ªùi gian</li>
                <li>T·ªëi ƒëa gia h·∫°n 3 l·∫ßn</li>
                <li><strong>ƒê·∫∑t gi√° t·ª± ƒë·ªông:</strong> H·ªá th·ªëng t·ª± ƒë·∫∑t gi√° khi b·ªã v∆∞·ª£t</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script th:inline="javascript">
      /*<![CDATA[*/
      const auctionId = /*[[${auction.auctionId}]]*/ 1;
      const userId = /*[[${currentUser.userId}]]*/ 1;
      const currentUsername = /*[[${currentUser.username}]]*/ 'User';
      let stompClient = null;
      let secondsRemaining = /*[[${auction.secondsRemaining}]]*/ 0;

      // Connect to WebSocket
      function connectWebSocket() {
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
          console.log("Connected to WebSocket");

          // Subscribe to auction updates
          stompClient.subscribe(
            "/topic/auction/" + auctionId,
            function (message) {
              const update = JSON.parse(message.body);
              handleAuctionUpdate(update);
            }
          );

          // Send join message
          stompClient.send(
            "/app/join/" + auctionId,
            {},
            JSON.stringify({
              username: currentUsername,
            })
          );
        });
      }

      // Handle real-time updates
      function handleAuctionUpdate(update) {
        if (update.type === "BID_UPDATE") {
          document.getElementById("currentPrice").textContent =
            new Intl.NumberFormat("vi-VN").format(update.newPrice) + " VND";
          document.getElementById("highestBidder").textContent =
            update.bidderName;
          document.getElementById("totalBids").textContent = update.totalBids;
          secondsRemaining = update.timeLeft;

          showStatusMessage(
            "üîî " + update.bidderName + " v·ª´a ƒë·∫∑t gi√° m·ªõi!",
            "warning"
          );
          loadBidHistory();
        } else if (update.type === "AUCTION_EXTENDED") {
          showStatusMessage(
            "‚è∞ ƒê·∫•u gi√° ƒë∆∞·ª£c gia h·∫°n th√™m " + update.extendedSeconds + " gi√¢y!",
            "info"
          );
        }
      }

      // Place bid
      document
        .getElementById("bidForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const bidAmount = parseInt(
            document.getElementById("bidAmount").value
          );

          try {
            const response = await fetch("/api/bids?userId=" + userId, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ auctionId, bidAmount }),
            });

            const result = await response.json();

            if (result.success) {
              showStatusMessage("‚úÖ ƒê·∫∑t gi√° th√†nh c√¥ng!", "success");
            } else {
              showStatusMessage("‚ùå " + result.message, "danger");
            }
          } catch (error) {
            showStatusMessage("‚ùå C√≥ l·ªói x·∫£y ra!", "danger");
          }
        });

      function quickBid() {
        const minBid = parseInt(document.getElementById("bidAmount").value);
        document.getElementById("bidAmount").value = minBid;
        document.getElementById("bidForm").dispatchEvent(new Event("submit"));
      }

      function showStatusMessage(message, type) {
        const statusDiv = document.getElementById("statusMessage");
        statusDiv.className = "alert alert-" + type;
        statusDiv.textContent = message;
        statusDiv.style.display = "block";

        setTimeout(() => {
          statusDiv.style.display = "none";
        }, 3000);
      }

      // Countdown timer
      function updateTimer() {
        if (secondsRemaining > 0) {
          const hours = Math.floor(secondsRemaining / 3600);
          const minutes = Math.floor((secondsRemaining % 3600) / 60);
          const seconds = secondsRemaining % 60;

          document.getElementById(
            "timeRemaining"
          ).textContent = `${hours}h ${minutes}m ${seconds}s`;
          secondsRemaining--;
        } else {
          document.getElementById("timeRemaining").textContent = "ƒê√£ k·∫øt th√∫c";
        }
      }

      // Load bid history
      async function loadBidHistory() {
        try {
          const response = await fetch("/api/bids/auction/" + auctionId);
          const result = await response.json();

          if (result.success) {
            displayBidHistory(result.data);
          }
        } catch (error) {
          console.error("Error loading bid history:", error);
        }
      }

      function displayBidHistory(bids) {
        const container = document.getElementById("bidHistoryList");
        container.innerHTML = "";

        if (bids.length === 0) {
          container.innerHTML =
            '<p class="text-muted">Ch∆∞a c√≥ l∆∞·ª£t ƒë·∫∑t gi√° n√†o</p>';
          return;
        }

        bids.forEach((bid) => {
          const bidItem = `
                    <div class="border-bottom py-2">
                        <div class="d-flex justify-content-between">
                            <strong>${bid.username}</strong>
                            <span class="text-success fw-bold">
                                ${new Intl.NumberFormat("vi-VN").format(
                                  bid.bidAmount
                                )} VND
                            </span>
                        </div>
                        <small class="text-muted">${new Date(
                          bid.bidTime
                        ).toLocaleString("vi-VN")}</small>
                    </div>
                `;
          container.innerHTML += bidItem;
        });
      }

      // Auto Bid functions
      let currentAutoBid = null;

      document
        .getElementById("autoBidForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const maxAmount = parseInt(
            document.getElementById("autoBidMaxAmount").value
          );
          const incrementAmount = parseInt(
            document.getElementById("autoBidIncrement").value
          );

          try {
            const response = await fetch(
              `/api/autobids?userId=${userId}&auctionId=${auctionId}&maxAmount=${maxAmount}&incrementAmount=${incrementAmount}`,
              { method: "POST" }
            );

            const result = await response.json();

            if (result.success) {
              showStatusMessage("‚úÖ Auto Bid ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t!", "success");
              currentAutoBid = result.data;
              updateAutoBidDisplay();
            } else {
              showStatusMessage("‚ùå " + result.message, "danger");
            }
          } catch (error) {
            showStatusMessage("‚ùå C√≥ l·ªói x·∫£y ra!", "danger");
          }
        });

      async function loadAutoBid() {
        try {
          const response = await fetch(
            `/api/autobids/auction/${auctionId}?userId=${userId}`
          );
          const result = await response.json();

          if (result.success && result.data) {
            currentAutoBid = result.data;
            updateAutoBidDisplay();
          }
        } catch (error) {
          console.log("No auto bid for this auction");
        }
      }

      function updateAutoBidDisplay() {
        if (currentAutoBid) {
          document.getElementById("autoBidForm").style.display = "none";
          document.getElementById("autoBidStatus").style.display = "block";
          document.getElementById("autoBidMaxDisplay").textContent =
            new Intl.NumberFormat("vi-VN").format(currentAutoBid.maxAmount) +
            " VND";
          document.getElementById("autoBidIncrementDisplay").textContent =
            new Intl.NumberFormat("vi-VN").format(
              currentAutoBid.incrementAmount
            ) + " VND";
        } else {
          document.getElementById("autoBidForm").style.display = "block";
          document.getElementById("autoBidStatus").style.display = "none";
        }
      }

      async function cancelAutoBid() {
        if (!confirm("H·ªßy auto bid?")) return;

        try {
          const response = await fetch(
            `/api/autobids/${currentAutoBid.autoBidId}?userId=${userId}`,
            { method: "DELETE" }
          );

          const result = await response.json();

          if (result.success) {
            showStatusMessage("‚úÖ ƒê√£ h·ªßy auto bid", "success");
            currentAutoBid = null;
            updateAutoBidDisplay();
          } else {
            showStatusMessage("‚ùå " + result.message, "danger");
          }
        } catch (error) {
          showStatusMessage("‚ùå C√≥ l·ªói x·∫£y ra!", "danger");
        }
      }

      // Watchlist functions
      let isInWatchlist = false;

      async function loadWatchlistStatus() {
        try {
          const response = await fetch(
            `/api/watchlist/check?userId=${userId}&auctionId=${auctionId}`
          );
          const result = await response.json();

          if (result.success) {
            isInWatchlist = result.data;
            updateWatchlistButton();
          }
        } catch (error) {
          console.log("Error checking watchlist status");
        }
      }

      function updateWatchlistButton() {
        const btn = document.getElementById("watchlistBtn");
        if (isInWatchlist) {
          btn.textContent = "‚≠ê ƒê√£ Theo D√µi";
          btn.className = "btn btn-warning btn-sm w-100";
        } else {
          btn.textContent = "‚≠ê Th√™m v√†o Danh S√°ch Theo D√µi";
          btn.className = "btn btn-outline-secondary btn-sm w-100";
        }
      }

      async function toggleWatchlist() {
        try {
          if (isInWatchlist) {
            // Remove
            const response = await fetch(
              `/api/watchlist/auction/${auctionId}?userId=${userId}`,
              { method: "DELETE" }
            );

            const result = await response.json();

            if (result.success) {
              showStatusMessage("‚úÖ ƒê√£ x√≥a kh·ªèi watchlist", "success");
              isInWatchlist = false;
              updateWatchlistButton();
            }
          } else {
            // Add
            const response = await fetch(
              `/api/watchlist?userId=${userId}&auctionId=${auctionId}`,
              { method: "POST" }
            );

            const result = await response.json();

            if (result.success) {
              showStatusMessage("‚úÖ ƒê√£ th√™m v√†o watchlist", "success");
              isInWatchlist = true;
              updateWatchlistButton();
            } else {
              showStatusMessage("‚ùå " + result.message, "danger");
            }
          }
        } catch (error) {
          showStatusMessage("‚ùå C√≥ l·ªói x·∫£y ra!", "danger");
        }
      }

      // Initialize
      window.addEventListener("load", function () {
        connectWebSocket();
        loadBidHistory();
        loadAutoBid();
        loadWatchlistStatus();
        setInterval(updateTimer, 1000);
      });
      /*]]>*/
    </script>
  </body>
</html>
