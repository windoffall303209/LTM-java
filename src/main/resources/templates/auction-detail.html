<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${auction.title} + ' - Auction System'">
      Auction Detail
    </title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
    <style>
      /* Sticky navbar that shrinks on scroll */
      .navbar {
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 1000;
        transition: all 0.3s ease;
      }
      
      .navbar.navbar-shrink {
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
      }
      
      .navbar.navbar-shrink .navbar-brand {
        font-size: 1rem;
      }
      
      body {
        padding-top: 70px; /* Space for fixed navbar */
      }
      
      /* Sticky sidebar */
      .sticky-sidebar {
        position: sticky;
        top: 80px; /* Below navbar */
        max-height: calc(100vh - 100px);
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary" id="mainNav">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/dashboard">üî® Auction System</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link text-white fw-semibold" href="/dashboard">‚Üê Quay l·∫°i Dashboard</a>
            </li>
          </ul>
          <ul class="navbar-nav">
            <!-- User Balance -->
            <li class="nav-item d-none d-lg-block">
              <span class="nav-link text-white">
                <strong>üí∞ <span th:text="${#numbers.formatDecimal(currentUser.balance, 0, 'COMMA', 0, 'POINT')} + ' VND'">10,000,000 VND</span></strong>
              </span>
            </li>
            <!-- Username with Dropdown -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <strong>üë§ <span th:text="${currentUser.fullName != null && !currentUser.fullName.isEmpty() ? currentUser.fullName : currentUser.username}">User</span></strong>
                <span th:if="${isAdmin}" class="badge bg-warning text-dark ms-1">ADMIN</span>
                <span th:unless="${isAdmin}" class="badge bg-info ms-1">USER</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li class="dropdown-header">
                  <strong>Th√¥ng tin t√†i kho·∫£n</strong>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <span class="dropdown-item-text">
                    <small class="text-muted">T√™n ƒë·∫ßy ƒë·ªß:</small><br/>
                    <strong th:text="${currentUser.fullName}">Full Name</strong>
                  </span>
                </li>
                <li>
                  <span class="dropdown-item-text">
                    <small class="text-muted">Email:</small><br/>
                    <strong th:text="${currentUser.email}">email@example.com</strong>
                  </span>
                </li>
                <li>
                  <span class="dropdown-item-text">
                    <small class="text-muted">S·ªë d∆∞:</small><br/>
                    <strong class="text-success" th:text="${#numbers.formatDecimal(currentUser.balance, 0, 'COMMA', 0, 'POINT')} + ' VND'">0 VND</strong>
                  </span>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <form method="POST" th:action="@{/api/auth/logout}" class="px-2">
                    <button type="submit" class="btn btn-danger btn-sm w-100">
                      <i class="bi bi-box-arrow-right"></i> ƒêƒÉng xu·∫•t
                    </button>
                  </form>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container py-4">
      <div class="row">
        <!-- Main Auction Info -->
        <div class="col-md-8">
          <div class="card mb-4">
            <img
              th:src="${auction.imageUrl != null ? auction.imageUrl : 'https://via.placeholder.com/800x400'}"
              class="card-img-top"
              alt="Auction Image"
              style="max-height: 400px; object-fit: cover"
            />
            <div class="card-body">
              <h2 class="card-title" th:text="${auction.title}">
                Auction Title
              </h2>
              <p class="card-text" th:text="${auction.description}">
                Description...
              </p>

              <hr />

              <div class="row">
                <div class="col-md-6">
                  <h5>Gi√° kh·ªüi ƒëi·ªÉm:</h5>
                  <p
                    class="fs-5"
                    th:text="${#numbers.formatDecimal(auction.startingPrice, 0, 'COMMA', 0, 'POINT')} + ' VND'"
                  >
                    0 VND
                  </p>
                </div>
                <div class="col-md-6">
                  <h5>Gi√° hi·ªán t·∫°i:</h5>
                  <p
                    class="fs-3 text-success fw-bold"
                    id="currentPrice"
                    th:text="${#numbers.formatDecimal(auction.currentPrice, 0, 'COMMA', 0, 'POINT')} + ' VND'"
                  >
                    0 VND
                  </p>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <strong>Ng∆∞·ªùi d·∫´n ƒë·∫ßu:</strong>
                  <span
                    class="fs-5 text-primary"
                    id="highestBidder"
                    th:text="${auction.highestBidder}"
                    >Ch∆∞a c√≥</span
                  >
                </div>
                <div class="col-md-6">
                  <strong>T·ªïng l∆∞·ª£t ƒë·∫∑t:</strong>
                  <span
                    class="fs-5"
                    id="totalBids"
                    th:text="${auction.totalBids}"
                    >0</span
                  >
                </div>
              </div>

              <div class="alert alert-info">
                <strong>Th·ªùi gian c√≤n l·∫°i:</strong>
                <h3 class="mb-0 text-danger" id="timeRemaining">Loading...</h3>
              </div>

              <!-- Real-time Status -->
              <div id="statusMessage" class="alert" style="display: none"></div>
            </div>
          </div>

          <!-- Bid History -->
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">L·ªãch S·ª≠ ƒê·∫∑t Gi√°</h5>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto">
              <div id="bidHistoryList">
                <!-- Bid history will be loaded here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Bidding Panel -->
        <div class="col-md-4">
          <div class="sticky-sidebar">
            <div class="card">
              <div class="card-header bg-success text-white">
                <h5 class="mb-0">ƒê·∫∑t Gi√° Ngay</h5>
              </div>
              <div class="card-body">
              <!-- Status Badge -->
              <div class="mb-3 text-center">
                <span th:if="${auction.status == 'PENDING'}" class="badge bg-warning text-dark fs-6">
                  <i class="bi bi-clock-history"></i> Ch∆∞a b·∫Øt ƒë·∫ßu
                </span>
                <span th:if="${auction.status == 'ACTIVE'}" class="badge bg-success fs-6">
                  <i class="bi bi-broadcast"></i> ƒêang di·ªÖn ra
                </span>
                <span th:if="${auction.status == 'ENDED'}" class="badge bg-secondary fs-6">
                  <i class="bi bi-flag"></i> ƒê√£ k·∫øt th√∫c
                </span>
              </div>

              <!-- Pending Message -->
              <div th:if="${auction.status == 'PENDING'}" class="alert alert-warning">
                <strong><i class="bi bi-info-circle"></i> ƒê·∫•u gi√° ch∆∞a b·∫Øt ƒë·∫ßu!</strong>
                <p class="mb-0 small">B·∫Øt ƒë·∫ßu l√∫c: <strong th:text="${#temporals.format(auction.startTime, 'dd/MM/yyyy HH:mm')}">...</strong></p>
                <p class="mb-0 small">H√£y th√™m v√†o danh s√°ch theo d√µi ƒë·ªÉ kh√¥ng b·ªè l·ª°!</p>
              </div>

              <form id="bidForm" th:if="${auction.status == 'ACTIVE'}">
                <div class="mb-3">
                  <label class="form-label">Gi√° t·ªëi thi·ªÉu:</label>
                  <p
                    class="fs-5 fw-bold text-danger"
                    id="minimumBid"
                    th:text="${#numbers.formatDecimal(auction.minimumBid, 0, 'COMMA', 0, 'POINT')} + ' VND'"
                  >
                    0 VND
                  </p>
                </div>

                <div class="mb-3">
                  <label for="bidAmount" class="form-label"
                    >S·ªë ti·ªÅn ƒë·∫∑t gi√°:</label
                  >
                  <input
                    type="number"
                    class="form-control form-control-lg"
                    id="bidAmount"
                    required
                    th:value="${auction.minimumBid}"
                    step="100000"
                  />
                  <small class="text-muted">B·ªôi s·ªë c·ªßa 100,000 VND</small>
                </div>

                <button type="submit" class="btn btn-success btn-lg w-100 mb-2">
                  üî® ƒê·∫∑t Gi√° Ngay
                </button>

                <div class="d-grid gap-2">
                  <button
                    type="button"
                    class="btn btn-outline-primary"
                    onclick="quickBid()"
                  >
                    Quick Bid (Min Price)
                  </button>
                </div>
              </form>

              <!-- Info for pending/ended -->
              <div th:if="${auction.status == 'PENDING' || auction.status == 'ENDED'}">
                <div class="mb-3">
                  <label class="form-label">Gi√° kh·ªüi ƒëi·ªÉm:</label>
                  <p
                    class="fs-5 fw-bold text-success"
                    th:text="${#numbers.formatDecimal(auction.startingPrice, 0, 'COMMA', 0, 'POINT')} + ' VND'"
                  >
                    0 VND
                  </p>
                </div>
              </div>

              <hr />

              <!-- Watchlist Button -->
              <div class="text-center">
                <button
                  class="btn btn-outline-secondary btn-sm w-100"
                  id="watchlistBtn"
                  onclick="toggleWatchlist()"
                >
                  ‚≠ê Th√™m v√†o Danh S√°ch Theo D√µi
                </button>
              </div>
            </div>

            <!-- Tips -->
            <div class="card mt-3">
              <div class="card-body small">
                <h6>üí° L∆∞u √Ω:</h6>
                <ul class="mb-0">
                  <li>Gi√° c·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c (real-time)</li>
                  <li>ƒê·∫∑t gi√° trong 60 gi√¢y cu·ªëi s·∫Ω ƒë∆∞·ª£c gia h·∫°n th√™m th·ªùi gian</li>
                  <li>T·ªëi ƒëa gia h·∫°n 3 l·∫ßn</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script th:inline="javascript">
      /*<![CDATA[*/
      const auctionId = /*[[${auction.auctionId}]]*/ 1;
      const userId = /*[[${currentUser.userId}]]*/ 1;
      const currentUsername = /*[[${currentUser.username}]]*/ 'User';
      let stompClient = null;
      let secondsRemaining = /*[[${auction.secondsRemaining}]]*/ 0;

      // Connect to WebSocket
      function connectWebSocket() {
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
          console.log("Connected to WebSocket");

          // Subscribe to auction updates
          stompClient.subscribe(
            "/topic/auction/" + auctionId,
            function (message) {
              const update = JSON.parse(message.body);
              handleAuctionUpdate(update);
            }
          );

          // Send join message
          stompClient.send(
            "/app/join/" + auctionId,
            {},
            JSON.stringify({
              username: currentUsername,
            })
          );
        });
      }

      // Handle real-time updates
      function handleAuctionUpdate(update) {
        if (update.type === "BID_UPDATE") {
          document.getElementById("currentPrice").textContent =
            new Intl.NumberFormat("vi-VN").format(update.newPrice) + " VND";
          document.getElementById("highestBidder").textContent =
            update.bidderName;
          document.getElementById("totalBids").textContent = update.totalBids;
          secondsRemaining = update.timeLeft;

          // C·∫≠p nh·∫≠t gi√° ƒë·∫∑t t·ªëi thi·ªÉu
          if (update.minimumBid) {
            document.getElementById("minimumBid").textContent =
              new Intl.NumberFormat("vi-VN").format(update.minimumBid) + " VND";
            // C·∫≠p nh·∫≠t gi√° tr·ªã m·∫∑c ƒë·ªãnh trong input
            const bidAmountInput = document.getElementById("bidAmount");
            if (bidAmountInput) {
              bidAmountInput.value = update.minimumBid;
              bidAmountInput.setAttribute("min", update.minimumBid);
            }
          }

          showStatusMessage(
            "üîî " + update.bidderName + " v·ª´a ƒë·∫∑t gi√° m·ªõi!",
            "warning"
          );
          loadBidHistory();
        } else if (update.type === "AUCTION_EXTENDED") {
          showStatusMessage(
            "‚è∞ ƒê·∫•u gi√° ƒë∆∞·ª£c gia h·∫°n th√™m " + update.extendedSeconds + " gi√¢y!",
            "info"
          );
        } else if (update.type === "AUCTION_ENDED") {
          secondsRemaining = 0;
          let endMessage = "üèÅ ƒê·∫•u gi√° ƒë√£ k·∫øt th√∫c!";
          if (update.reason) {
            endMessage += " - " + update.reason;
          }
          if (update.winner) {
            endMessage += " üèÜ Ng∆∞·ªùi th·∫Øng: " + update.winner + " v·ªõi gi√° " + 
              new Intl.NumberFormat("vi-VN").format(update.finalPrice) + " VND";
          }
          showStatusMessage(endMessage, "danger");
          
          // Disable bid form
          const bidForm = document.getElementById("bidForm");
          if (bidForm) {
            bidForm.querySelectorAll("input, button").forEach(el => el.disabled = true);
          }
          
          // Reload page sau 3 gi√¢y
          setTimeout(() => location.reload(), 3000);
        } else if (update.type === "AUCTION_STARTED") {
          showStatusMessage("üöÄ ƒê·∫•u gi√° ƒë√£ b·∫Øt ƒë·∫ßu!", "success");
          setTimeout(() => location.reload(), 2000);
        }
      }

      // Place bid
      document
        .getElementById("bidForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const bidAmount = parseInt(
            document.getElementById("bidAmount").value
          );

          try {
            const response = await fetch("/api/bids?userId=" + userId, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ auctionId, bidAmount }),
            });

            const result = await response.json();

            if (result.success) {
              showStatusMessage("‚úÖ ƒê·∫∑t gi√° th√†nh c√¥ng!", "success");
            } else {
              showStatusMessage("‚ùå " + result.message, "danger");
            }
          } catch (error) {
            showStatusMessage("‚ùå C√≥ l·ªói x·∫£y ra!", "danger");
          }
        });

      function quickBid() {
        const minBid = parseInt(document.getElementById("bidAmount").value);
        document.getElementById("bidAmount").value = minBid;
        document.getElementById("bidForm").dispatchEvent(new Event("submit"));
      }

      function showStatusMessage(message, type) {
        const statusDiv = document.getElementById("statusMessage");
        statusDiv.className = "alert alert-" + type;
        statusDiv.textContent = message;
        statusDiv.style.display = "block";

        setTimeout(() => {
          statusDiv.style.display = "none";
        }, 3000);
      }

      // Countdown timer
      function updateTimer() {
        if (secondsRemaining > 0) {
          const hours = Math.floor(secondsRemaining / 3600);
          const minutes = Math.floor((secondsRemaining % 3600) / 60);
          const seconds = secondsRemaining % 60;

          document.getElementById(
            "timeRemaining"
          ).textContent = `${hours}h ${minutes}m ${seconds}s`;
          secondsRemaining--;
        } else {
          document.getElementById("timeRemaining").textContent = "ƒê√£ k·∫øt th√∫c";
        }
      }

      // Load bid history
      async function loadBidHistory() {
        try {
          const response = await fetch("/api/bids/auction/" + auctionId);
          const result = await response.json();

          if (result.success) {
            displayBidHistory(result.data);
          }
        } catch (error) {
          console.error("Error loading bid history:", error);
        }
      }

      function displayBidHistory(bids) {
        const container = document.getElementById("bidHistoryList");
        container.innerHTML = "";

        if (bids.length === 0) {
          container.innerHTML =
            '<p class="text-muted">Ch∆∞a c√≥ l∆∞·ª£t ƒë·∫∑t gi√° n√†o</p>';
          return;
        }

        bids.forEach((bid) => {
          // Hi·ªÉn th·ªã fullName n·∫øu c√≥, n·∫øu kh√¥ng th√¨ hi·ªÉn th·ªã username
          const displayName = (bid.fullName && bid.fullName.trim() !== '') ? bid.fullName : bid.username;
          
          const bidItem = `
                    <div class="border-bottom py-2">
                        <div class="d-flex justify-content-between">
                            <strong>${displayName}</strong>
                            <span class="text-success fw-bold">
                                ${new Intl.NumberFormat("vi-VN").format(
                                  bid.bidAmount
                                )} VND
                            </span>
                        </div>
                        <small class="text-muted">${new Date(
                          bid.bidTime
                        ).toLocaleString("vi-VN")}</small>
                    </div>
                `;
          container.innerHTML += bidItem;
        });
      }

      // Watchlist functions
      let isInWatchlist = false;

      async function loadWatchlistStatus() {
        try {
          const response = await fetch(
            `/api/watchlist/check?userId=${userId}&auctionId=${auctionId}`
          );
          const result = await response.json();

          if (result.success) {
            isInWatchlist = result.data;
            updateWatchlistButton();
          }
        } catch (error) {
          console.log("Error checking watchlist status");
        }
      }

      function updateWatchlistButton() {
        const btn = document.getElementById("watchlistBtn");
        if (isInWatchlist) {
          btn.textContent = "‚≠ê ƒê√£ Theo D√µi";
          btn.className = "btn btn-warning btn-sm w-100";
        } else {
          btn.textContent = "‚≠ê Th√™m v√†o Danh S√°ch Theo D√µi";
          btn.className = "btn btn-outline-secondary btn-sm w-100";
        }
      }

      async function toggleWatchlist() {
        try {
          if (isInWatchlist) {
            // Remove
            const response = await fetch(
              `/api/watchlist/auction/${auctionId}?userId=${userId}`,
              { method: "DELETE" }
            );

            const result = await response.json();

            if (result.success) {
              showStatusMessage("‚úÖ ƒê√£ x√≥a kh·ªèi watchlist", "success");
              isInWatchlist = false;
              updateWatchlistButton();
            }
          } else {
            // Add
            const response = await fetch(
              `/api/watchlist?userId=${userId}&auctionId=${auctionId}`,
              { method: "POST" }
            );

            const result = await response.json();

            if (result.success) {
              showStatusMessage("‚úÖ ƒê√£ th√™m v√†o watchlist", "success");
              isInWatchlist = true;
              updateWatchlistButton();
            } else {
              showStatusMessage("‚ùå " + result.message, "danger");
            }
          }
        } catch (error) {
          showStatusMessage("‚ùå C√≥ l·ªói x·∫£y ra!", "danger");
        }
      }

      // Navbar shrink on scroll
      window.addEventListener('scroll', function() {
        const navbar = document.getElementById('mainNav');
        if (window.scrollY > 50) {
          navbar.classList.add('navbar-shrink');
        } else {
          navbar.classList.remove('navbar-shrink');
        }
      });

      // Initialize
      window.addEventListener("load", function () {
        connectWebSocket();
        loadBidHistory();
        loadWatchlistStatus();
        setInterval(updateTimer, 1000);
      });
      /*]]>*/
    </script>
  </body>
</html>
