<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n L√Ω ƒê·∫•u Gi√° - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
    <!-- Admin Custom CSS -->
    <link rel="stylesheet" href="../css/admin-style.css" />
  </head>
  <body class="admin-panel">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark admin-navbar">
      <div class="container-fluid">
        <a class="navbar-brand" href="dashboard.html">üëë Admin Panel</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="dashboard.html">Dashboard</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="auctions.html">Qu·∫£n L√Ω ƒê·∫•u Gi√°</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="users.html">Qu·∫£n L√Ω Users</a>
            </li>
          </ul>
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="../dashboard.html">
                <i class="bi bi-house"></i> Trang Ch·ªß
              </a>
            </li>
            <li class="nav-item">
              <span class="nav-link text-warning">
                <i class="bi bi-person-badge"></i> <span id="adminName">Admin</span>
              </span>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="Auth.logout()">
                <i class="bi bi-box-arrow-right"></i> ƒêƒÉng xu·∫•t
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid py-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üî® Qu·∫£n L√Ω ƒê·∫•u Gi√°</h2>
        <div class="d-flex gap-2">
          <input type="text" id="searchInput" class="form-control" placeholder="T√¨m ki·∫øm ƒë·∫•u gi√°..." style="width: 300px;" />
          <select id="statusFilter" class="form-select" style="width: 200px;">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="PENDING">S·∫Øp di·ªÖn ra</option>
            <option value="ACTIVE">ƒêang di·ªÖn ra</option>
            <option value="ENDED">ƒê√£ k·∫øt th√∫c</option>
          </select>
          <button class="btn btn-success" onclick="openCreateModal()">
            <i class="bi bi-plus-circle"></i> T·∫°o ƒê·∫•u Gi√° M·ªõi
          </button>
        </div>
      </div>

      <!-- Statistics Cards -->
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <h6 class="text-muted">T·ªïng ƒê·∫•u Gi√°</h6>
              <h3 id="totalAuctionsCount">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <h6 class="text-muted">S·∫Øp Di·ªÖn Ra</h6>
              <h3 class="text-warning" id="pendingAuctionsCount">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <h6 class="text-muted">ƒêang Di·ªÖn Ra</h6>
              <h3 class="text-success" id="activeAuctionsCount">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <h6 class="text-muted">ƒê√£ K·∫øt Th√∫c</h6>
              <h3 class="text-muted" id="endedAuctionsCount">0</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- Auctions Table -->
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Danh S√°ch ƒê·∫•u Gi√°</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>·∫¢nh</th>
                  <th>Ti√™u ƒê·ªÅ</th>
                  <th>Gi√° Kh·ªüi ƒêi·ªÉm</th>
                  <th>Gi√° Hi·ªán T·∫°i</th>
                  <th>Ng∆∞·ªùi B√°n</th>
                  <th>L∆∞·ª£t ƒê·∫∑t Gi√°</th>
                  <th>Tr·∫°ng Th√°i</th>
                  <th>Th·ªùi Gian</th>
                  <th>H√†nh ƒê·ªông</th>
                </tr>
              </thead>
              <tbody id="auctionsTableBody">
                <tr>
                  <td colspan="10" class="text-center">
                    <div class="spinner-border text-primary" role="status"></div>
                    Loading...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Create/Edit Auction Modal -->
    <div class="modal fade" id="auctionFormModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="formModalTitle">T·∫°o ƒê·∫•u Gi√° M·ªõi</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form id="auctionForm" onsubmit="handleSubmitAuction(event)">
            <div class="modal-body">
              <input type="hidden" id="auctionId" />
              <input type="hidden" id="formMode" value="create" />

              <div class="mb-3">
                <label for="auctionTitle" class="form-label">Ti√™u ƒê·ªÅ <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="auctionTitle" required />
              </div>

              <div class="mb-3">
                <label for="auctionDescription" class="form-label">M√¥ T·∫£ <span class="text-danger">*</span></label>
                <textarea class="form-control" id="auctionDescription" rows="3" required></textarea>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="startingPrice" class="form-label">Gi√° Kh·ªüi ƒêi·ªÉm (VND) <span class="text-danger">*</span></label>
                  <input type="number" class="form-control" id="startingPrice" min="0" step="1000" required />
                </div>

                <div class="col-md-6 mb-3">
                  <label for="durationMinutes" class="form-label">Th·ªùi L∆∞·ª£ng (ph√∫t)</label>
                  <input type="number" class="form-control" id="durationMinutes" min="1" value="60" />
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="startTime" class="form-label">Th·ªùi Gian B·∫Øt ƒê·∫ßu</label>
                  <input type="datetime-local" class="form-control" id="startTime" />
                  <small class="text-muted">ƒê·ªÉ tr·ªëng = b·∫Øt ƒë·∫ßu ngay</small>
                </div>

                <div class="col-md-6 mb-3">
                  <label for="endTime" class="form-label">Th·ªùi Gian K·∫øt Th√∫c</label>
                  <input type="datetime-local" class="form-control" id="endTime" />
                  <small class="text-muted">Ho·∫∑c d√πng th·ªùi l∆∞·ª£ng</small>
                </div>
              </div>

              <div class="mb-3">
                <label for="imageUrl" class="form-label">URL H√¨nh ·∫¢nh</label>
                <input type="url" class="form-control" id="imageUrl" placeholder="https://example.com/image.jpg" />
                <small class="text-muted">ƒê·ªÉ tr·ªëng s·∫Ω d√πng ·∫£nh m·∫∑c ƒë·ªãnh</small>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
              <button type="submit" class="btn btn-primary" id="submitBtn">
                <i class="bi bi-save"></i> L∆∞u
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Auction Detail Modal -->
    <div class="modal fade" id="auctionDetailModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Chi Ti·∫øt ƒê·∫•u Gi√°</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <img id="detailImage" src="" class="img-fluid rounded mb-3" alt="Auction Image" style="max-height: 300px; width: 100%; object-fit: cover;" />
                <h4 id="detailTitle">-</h4>
                <p id="detailDescription" class="text-muted">-</p>
              </div>
              <div class="col-md-6">
                <table class="table table-sm">
                  <tr>
                    <th>ID:</th>
                    <td id="detailId">-</td>
                  </tr>
                  <tr>
                    <th>Gi√° Kh·ªüi ƒêi·ªÉm:</th>
                    <td id="detailStartPrice" class="text-success">-</td>
                  </tr>
                  <tr>
                    <th>Gi√° Hi·ªán T·∫°i:</th>
                    <td id="detailCurrentPrice" class="text-success fw-bold">-</td>
                  </tr>
                  <tr>
                    <th>Ng∆∞·ªùi D·∫´n ƒê·∫ßu:</th>
                    <td id="detailHighestBidder">-</td>
                  </tr>
                  <tr>
                    <th>Ng∆∞·ªùi B√°n:</th>
                    <td id="detailSeller">-</td>
                  </tr>
                  <tr>
                    <th>T·ªïng L∆∞·ª£t ƒê·∫∑t Gi√°:</th>
                    <td id="detailTotalBids">-</td>
                  </tr>
                  <tr>
                    <th>Tr·∫°ng Th√°i:</th>
                    <td id="detailStatus">-</td>
                  </tr>
                  <tr>
                    <th>Th·ªùi Gian B·∫Øt ƒê·∫ßu:</th>
                    <td id="detailStartTime">-</td>
                  </tr>
                  <tr>
                    <th>Th·ªùi Gian K·∫øt Th√∫c:</th>
                    <td id="detailEndTime">-</td>
                  </tr>
                </table>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <a id="detailViewLink" href="#" class="btn btn-primary" target="_blank">
              <i class="bi bi-eye"></i> Xem Trang ƒê·∫•u Gi√°
            </a>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <!-- Admin Scripts -->
    <script src="../js/admin-config.js"></script>
    <script src="../js/admin-auth.js"></script>
    <script src="../js/admin-main.js"></script>
    <script src="../js/admin-header.js"></script>
    <script>
      // Require admin authentication
      if (!AdminAuth.requireAdmin()) {
        throw new Error('Unauthorized');
      }

      // Render admin header
      renderAdminHeader('auctions');

      let allAuctions = [];
      let stompClient = null;
      let wsConnected = false;

      /**
       * Load all auctions (including ended)
       */
      async function loadAuctions() {
        try {
          const response = await fetch(`${window.ADMIN_API_CONFIG.BASE_URL}/api/admin/auctions/all`, {
            credentials: 'include'
          });

          if (!response.ok) {
            throw new Error('Failed to load auctions');
          }

          const result = await response.json();

          if (result.success) {
            allAuctions = result.data || [];
            updateStatistics();
            displayAuctions(allAuctions);
          } else {
            showError('Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë·∫•u gi√°');
          }
        } catch (error) {
          console.error('Error loading auctions:', error);
          showError('L·ªói k·∫øt n·ªëi ƒë·∫øn server');
        }
      }

      /**
       * Update statistics
       */
      function updateStatistics() {
        const total = allAuctions.length;
        const pending = allAuctions.filter(a => a.status === 'PENDING').length;
        const active = allAuctions.filter(a => a.status === 'ACTIVE').length;
        const ended = allAuctions.filter(a => a.status === 'ENDED').length;

        document.getElementById('totalAuctionsCount').textContent = total;
        document.getElementById('pendingAuctionsCount').textContent = pending;
        document.getElementById('activeAuctionsCount').textContent = active;
        document.getElementById('endedAuctionsCount').textContent = ended;
      }

      /**
       * Display auctions in table
       */
      function displayAuctions(auctions) {
        const tbody = document.getElementById('auctionsTableBody');

        if (!auctions || auctions.length === 0) {
          tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">Kh√¥ng c√≥ ƒë·∫•u gi√°</td></tr>';
          return;
        }

        tbody.innerHTML = '';

        auctions.forEach(auction => {
          const row = document.createElement('tr');
          const imageUrl = auction.imageUrl || 'https://via.placeholder.com/100';

          row.innerHTML = `
            <td>${auction.id}</td>
            <td>
              <img src="${imageUrl}" alt="${auction.title}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;" />
            </td>
            <td>
              <strong>${auction.title}</strong>
              ${auction.description && auction.description.length > 50
                ? '<br/><small class="text-muted">' + auction.description.substring(0, 50) + '...</small>'
                : ''}
            </td>
            <td>${formatCurrency(auction.startPrice)}</td>
            <td><strong class="text-success">${formatCurrency(auction.currentPrice)}</strong></td>
            <td>${auction.sellerName || 'N/A'}</td>
            <td>${auction.totalBids || 0}</td>
            <td>${getStatusBadge(auction.status)}</td>
            <td>
              <small class="text-muted">
                B·∫Øt ƒë·∫ßu: ${formatDate(auction.startTime)}<br/>
                K·∫øt th√∫c: ${formatDate(auction.endTime)}
              </small>
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-primary" onclick="viewAuctionDetail(${auction.id})" title="Xem">
                  <i class="bi bi-eye"></i>
                </button>
                ${auction.status === 'PENDING' || auction.status === 'ENDED' ? `
                  <button class="btn btn-outline-warning" onclick="openEditModal(${auction.id})" title="S·ª≠a">
                    <i class="bi bi-pencil"></i>
                  </button>
                ` : ''}
                ${auction.status === 'PENDING' ? `
                  <button class="btn btn-outline-success" onclick="startAuction(${auction.id})" title="B·∫Øt ƒë·∫ßu">
                    <i class="bi bi-play"></i>
                  </button>
                ` : ''}
                ${auction.status === 'ACTIVE' ? `
                  <button class="btn btn-outline-danger" onclick="endAuction(${auction.id})" title="K·∫øt th√∫c">
                    <i class="bi bi-stop"></i>
                  </button>
                ` : ''}
                ${auction.status === 'ENDED' || auction.status === 'PENDING' ? `
                  <button class="btn btn-outline-danger" onclick="deleteAuction(${auction.id})" title="X√≥a">
                    <i class="bi bi-trash"></i>
                  </button>
                ` : ''}
              </div>
            </td>
          `;
          tbody.appendChild(row);
        });
      }

      /**
       * View auction detail
       */
      async function viewAuctionDetail(auctionId) {
        try {
          const response = await fetch(`${window.ADMIN_API_CONFIG.BASE_URL}/api/auctions/${auctionId}`, {
            credentials: 'include'
          });

          const result = await response.json();

          if (result.success) {
            const auction = result.data;

            document.getElementById('detailId').textContent = auction.id;
            document.getElementById('detailTitle').textContent = auction.title;
            document.getElementById('detailDescription').textContent = auction.description || 'N/A';
            document.getElementById('detailImage').src = auction.imageUrl || 'https://via.placeholder.com/400';
            document.getElementById('detailStartPrice').textContent = formatCurrency(auction.startPrice);
            document.getElementById('detailCurrentPrice').textContent = formatCurrency(auction.currentPrice);
            document.getElementById('detailHighestBidder').textContent = auction.highestBidder || 'Ch∆∞a c√≥';
            document.getElementById('detailSeller').textContent = auction.sellerName || 'N/A';
            document.getElementById('detailTotalBids').textContent = auction.totalBids || 0;
            document.getElementById('detailStatus').innerHTML = getStatusBadge(auction.status);
            document.getElementById('detailStartTime').textContent = formatDateTime(auction.startTime);
            document.getElementById('detailEndTime').textContent = formatDateTime(auction.endTime);
            document.getElementById('detailViewLink').href = `../auction-detail.html?id=${auction.id}`;

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('auctionDetailModal'));
            modal.show();
          } else {
            alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ƒë·∫•u gi√°');
          }
        } catch (error) {
          console.error('Error loading auction detail:', error);
          alert('L·ªói khi t·∫£i th√¥ng tin ƒë·∫•u gi√°');
        }
      }

      /**
       * Apply filters
       */
      function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;

        let filtered = allAuctions;

        if (searchTerm) {
          filtered = filtered.filter(auction =>
            auction.title.toLowerCase().includes(searchTerm) ||
            (auction.description && auction.description.toLowerCase().includes(searchTerm)) ||
            (auction.sellerName && auction.sellerName.toLowerCase().includes(searchTerm))
          );
        }

        if (statusFilter) {
          filtered = filtered.filter(auction => auction.status === statusFilter);
        }

        displayAuctions(filtered);
      }

      // Add event listeners for filters
      document.getElementById('searchInput').addEventListener('input', applyFilters);
      document.getElementById('statusFilter').addEventListener('change', applyFilters);

      /**
       * Get status badge HTML
       */
      function getStatusBadge(status) {
        const badges = {
          'ACTIVE': '<span class="badge bg-success">ƒêang di·ªÖn ra</span>',
          'PENDING': '<span class="badge bg-warning">S·∫Øp di·ªÖn ra</span>',
          'ENDED': '<span class="badge bg-secondary">ƒê√£ k·∫øt th√∫c</span>'
        };
        return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
      }

      /**
       * Show error message
       */
      function showError(message) {
        const tbody = document.getElementById('auctionsTableBody');
        tbody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">${message}</td></tr>`;
      }

      /**
       * Format currency
       */
      function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN').format(amount) + ' VND';
      }

      /**
       * Format date (short)
       */
      function formatDate(dateString) {
        if (!dateString) return 'N/A';
        return new Date(dateString).toLocaleDateString('vi-VN');
      }

      /**
       * Format date time (full)
       */
      function formatDateTime(dateString) {
        if (!dateString) return 'N/A';
        return new Date(dateString).toLocaleString('vi-VN');
      }

      /**
       * Open create modal
       */
      function openCreateModal() {
        document.getElementById('formModalTitle').textContent = 'T·∫°o ƒê·∫•u Gi√° M·ªõi';
        document.getElementById('formMode').value = 'create';
        document.getElementById('auctionForm').reset();
        document.getElementById('auctionId').value = '';

        const modal = new bootstrap.Modal(document.getElementById('auctionFormModal'));
        modal.show();
      }

      /**
       * Open edit modal
       */
      async function openEditModal(auctionId) {
        try {
          const response = await fetch(`${window.ADMIN_API_CONFIG.BASE_URL}/api/auctions/${auctionId}`, {
            credentials: 'include'
          });
          const result = await response.json();

          if (result.success) {
            const auction = result.data;

            document.getElementById('formModalTitle').textContent = 'S·ª≠a ƒê·∫•u Gi√°';
            document.getElementById('formMode').value = 'edit';
            document.getElementById('auctionId').value = auction.id;
            document.getElementById('auctionTitle').value = auction.title;
            document.getElementById('auctionDescription').value = auction.description;
            document.getElementById('startingPrice').value = auction.startPrice;
            document.getElementById('durationMinutes').value = auction.durationMinutes || 60;
            document.getElementById('imageUrl').value = auction.imageUrl || '';

            // Format datetime for input
            if (auction.startTime) {
              const startDate = new Date(auction.startTime);
              document.getElementById('startTime').value = startDate.toISOString().slice(0, 16);
            }
            if (auction.endTime) {
              const endDate = new Date(auction.endTime);
              document.getElementById('endTime').value = endDate.toISOString().slice(0, 16);
            }

            const modal = new bootstrap.Modal(document.getElementById('auctionFormModal'));
            modal.show();
          } else {
            showToast('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ƒë·∫•u gi√°', 'danger');
          }
        } catch (error) {
          console.error('Error loading auction:', error);
          showToast('L·ªói khi t·∫£i th√¥ng tin ƒë·∫•u gi√°', 'danger');
        }
      }

      /**
       * Handle submit auction form (create or edit)
       */
      async function handleSubmitAuction(event) {
        event.preventDefault();

        const mode = document.getElementById('formMode').value;
        const auctionId = document.getElementById('auctionId').value;
        const title = document.getElementById('auctionTitle').value;
        const description = document.getElementById('auctionDescription').value;
        const startingPrice = document.getElementById('startingPrice').value;
        const durationMinutes = document.getElementById('durationMinutes').value;
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        const imageUrl = document.getElementById('imageUrl').value;

        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ƒêang x·ª≠ l√Ω...';

        try {
          let url, method;
          const formData = new URLSearchParams();

          formData.append('title', title);
          formData.append('description', description);
          formData.append('startingPrice', startingPrice);
          if (durationMinutes) formData.append('durationMinutes', durationMinutes);
          if (imageUrl) formData.append('imageUrl', imageUrl);

          if (mode === 'create') {
            url = `${window.ADMIN_API_CONFIG.BASE_URL}/api/admin/auctions`;
            method = 'POST';
            if (startTime) formData.append('startTime', startTime);
            if (endTime) formData.append('endTime', endTime);
          } else {
            url = `${window.ADMIN_API_CONFIG.BASE_URL}/api/admin/auctions/${auctionId}`;
            method = 'PUT';
          }

          const response = await fetch(url, {
            method: method,
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            credentials: 'include',
            body: formData
          });

          const result = await response.json();

          if (result.success) {
            showToast(mode === 'create' ? 'T·∫°o ƒë·∫•u gi√° th√†nh c√¥ng!' : 'C·∫≠p nh·∫≠t th√†nh c√¥ng!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('auctionFormModal')).hide();
            loadAuctions(); // Reload list
          } else {
            showToast(result.message || 'C√≥ l·ªói x·∫£y ra', 'danger');
          }
        } catch (error) {
          console.error('Error submitting auction:', error);
          showToast('L·ªói khi x·ª≠ l√Ω: ' + error.message, 'danger');
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="bi bi-save"></i> L∆∞u';
        }
      }

      /**
       * Delete auction
       */
      async function deleteAuction(auctionId) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë·∫•u gi√° n√†y?')) {
          return;
        }

        try {
          const response = await fetch(`${window.ADMIN_API_CONFIG.BASE_URL}/api/admin/auctions/${auctionId}`, {
            method: 'DELETE',
            credentials: 'include'
          });

          const result = await response.json();

          if (result.success) {
            showToast('ƒê√£ x√≥a ƒë·∫•u gi√°', 'success');
            loadAuctions();
          } else {
            showToast(result.message || 'Kh√¥ng th·ªÉ x√≥a', 'danger');
          }
        } catch (error) {
          console.error('Error deleting auction:', error);
          showToast('L·ªói khi x√≥a: ' + error.message, 'danger');
        }
      }

      /**
       * Start auction
       */
      async function startAuction(auctionId) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën b·∫Øt ƒë·∫ßu ƒë·∫•u gi√° n√†y?')) {
          return;
        }

        try {
          const response = await fetch(`${window.ADMIN_API_CONFIG.BASE_URL}/api/admin/auctions/${auctionId}/start`, {
            method: 'POST',
            credentials: 'include'
          });

          const result = await response.json();

          if (result.success) {
            showToast('ƒê√£ b·∫Øt ƒë·∫ßu ƒë·∫•u gi√°', 'success');
            loadAuctions();
          } else {
            showToast(result.message || 'Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu', 'danger');
          }
        } catch (error) {
          console.error('Error starting auction:', error);
          showToast('L·ªói khi b·∫Øt ƒë·∫ßu: ' + error.message, 'danger');
        }
      }

      /**
       * End auction
       */
      async function endAuction(auctionId) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën k·∫øt th√∫c ƒë·∫•u gi√° n√†y?')) {
          return;
        }

        try {
          const response = await fetch(`${window.ADMIN_API_CONFIG.BASE_URL}/api/admin/auctions/${auctionId}/end`, {
            method: 'POST',
            credentials: 'include'
          });

          const result = await response.json();

          if (result.success) {
            showToast('ƒê√£ k·∫øt th√∫c ƒë·∫•u gi√°', 'success');
            loadAuctions();
          } else {
            showToast(result.message || 'Kh√¥ng th·ªÉ k·∫øt th√∫c', 'danger');
          }
        } catch (error) {
          console.error('Error ending auction:', error);
          showToast('L·ªói khi k·∫øt th√∫c: ' + error.message, 'danger');
        }
      }

      /**
       * Show toast notification
       */
      function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        toast.style.zIndex = '9999';
        toast.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.remove();
        }, 3000);
      }

      /**
       * Connect to WebSocket for real-time auction updates
       */
      function connectWebSocket() {
        try {
          const socket = new SockJS(window.ADMIN_API_CONFIG.WS_URL);
          stompClient = Stomp.over(socket);

          stompClient.connect({},
            (frame) => {
              console.log('Admin WebSocket Connected:', frame);
              wsConnected = true;

              // Subscribe to auction events
              stompClient.subscribe('/topic/auctions', (message) => {
                const event = JSON.parse(message.body);
                handleAuctionEvent(event);
              });
            },
            (error) => {
              console.error('Admin WebSocket Error:', error);
              wsConnected = false;
              // Try to reconnect after 5 seconds
              setTimeout(() => connectWebSocket(), 5000);
            }
          );
        } catch (error) {
          console.error('Error connecting to WebSocket:', error);
        }
      }

      /**
       * Handle auction events from WebSocket
       */
      function handleAuctionEvent(event) {
        console.log('Admin received auction event:', event);

        // Reload auctions to reflect changes
        loadAuctions();

        // Show notification based on event type
        switch (event.type) {
          case 'AUCTION_CREATED':
            showToast('‚úÖ ƒê·∫•u gi√° m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o: ' + event.title, 'success');
            break;
          case 'AUCTION_STARTED':
            showToast('üöÄ ƒê·∫•u gi√° ƒë√£ b·∫Øt ƒë·∫ßu: ' + event.title, 'info');
            break;
          case 'AUCTION_ENDED':
            showToast('üèÅ ƒê·∫•u gi√° ƒë√£ k·∫øt th√∫c: ' + event.title, 'warning');
            break;
        }
      }

      // Load auctions on page load
      document.addEventListener('DOMContentLoaded', () => {
        loadAuctions();
        connectWebSocket();
      });

      // Cleanup WebSocket on page unload
      window.addEventListener('beforeunload', () => {
        if (stompClient && wsConnected) {
          stompClient.disconnect();
        }
      });
    </script>
  </body>
</html>
